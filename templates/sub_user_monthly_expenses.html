{% extends "sub_user_base.html" %}

{% block title %}Monthly Expenses{% endblock %}

{% block content %}
<style>
.professional-container {
    padding: 40px 30px;
    max-width: 1400px;
    margin: 0 auto;
}

.professional-header {
    margin-bottom: 35px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 20px;
}

.professional-title {
    font-size: 2rem;
    font-weight: 700;
    color: #1a1a2e;
    margin: 0;
}

.professional-subtitle {
    color: #6c757d;
    font-size: 1rem;
    margin-top: 5px;
}

.professional-card {
    background: white;
    border-radius: 16px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    padding: 30px;
    margin-bottom: 25px;
    transition: all 0.3s ease;
}

.professional-card:hover {
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
}

.card-header-custom {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px 25px;
    border-radius: 12px 12px 0 0;
    margin: -30px -30px 25px -30px;
}

.card-header-custom h5 {
    margin: 0;
    font-weight: 600;
    font-size: 1.25rem;
}

.summary-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.summary-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
    padding: 25px;
    color: white;
    text-align: center;
}

.summary-card.yearly {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.summary-card-label {
    font-size: 0.9rem;
    opacity: 0.9;
    margin-bottom: 10px;
    font-weight: 500;
}

.summary-card-value {
    font-size: 2rem;
    font-weight: 700;
    margin: 0;
}

.summary-card-formula {
    font-size: 0.85rem;
    opacity: 0.8;
    margin-top: 8px;
}

.form-label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 8px;
    font-size: 0.95rem;
}

.form-control, .form-select {
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 12px 16px;
    font-size: 0.95rem;
    transition: all 0.2s ease;
}

.form-control:focus, .form-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15);
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    padding: 12px 30px;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

.btn-danger {
    background: linear-gradient(135deg, #f5576c 0%, #d63447 100%);
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    font-weight: 500;
    transition: all 0.2s ease;
}

.btn-danger:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(245, 87, 108, 0.4);
}

.table-responsive {
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.table {
    margin-bottom: 0;
}

.table thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.table thead th {
    color: white;
    font-weight: 600;
    padding: 16px;
    border: none;
    font-size: 0.95rem;
}

.table tbody td {
    padding: 14px 16px;
    vertical-align: middle;
    font-size: 0.95rem;
    border-bottom: 1px solid #f0f0f0;
}

.table tbody tr:hover {
    background-color: #f8f9fa;
}

.badge {
    padding: 6px 12px;
    border-radius: 6px;
    font-weight: 500;
    font-size: 0.85rem;
}

.month-badge {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
}

.no-data {
    text-align: center;
    padding: 50px 20px;
    color: #6c757d;
}

.no-data i {
    font-size: 4rem;
    margin-bottom: 20px;
    opacity: 0.3;
}

.loading {
    text-align: center;
    padding: 50px;
    color: #667eea;
}

.loading i {
    font-size: 3rem;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@media (max-width: 768px) {
    .professional-container {
        padding: 20px 15px;
    }
    
    .professional-title {
        font-size: 1.5rem;
    }
    
    .summary-card-value {
        font-size: 1.5rem;
    }
    
    .table thead {
        display: none;
    }
    
    .table tbody tr {
        display: block;
        margin-bottom: 15px;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
    }
    
    .table tbody td {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border: none;
    }
    
    .table tbody td::before {
        content: attr(data-label);
        font-weight: 600;
        color: #495057;
    }
}
</style>

<div class="professional-container">
    <!-- Header -->
    <div class="professional-header">
        <div>
            <h1 class="professional-title">
                <i class="fas fa-calendar-alt me-2"></i>Monthly Expenses
            </h1>
            <p class="professional-subtitle">Track and manage your monthly recurring expenses</p>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="summary-cards" id="summaryCards">
        <div class="summary-card">
            <div class="summary-card-label">
                <i class="fas fa-calendar-check me-2"></i>Current Month Total
            </div>
            <div class="summary-card-value" id="monthlyTotal">৳0.00</div>
            <div class="summary-card-formula">Total for selected month</div>
        </div>
        <div class="summary-card yearly">
            <div class="summary-card-label">
                <i class="fas fa-calendar me-2"></i>Yearly Estimate
            </div>
            <div class="summary-card-value" id="yearlyTotal">৳0.00</div>
            <div class="summary-card-formula">Monthly total × 12 months</div>
        </div>
    </div>

    <!-- Add Expense Form -->
    <div class="professional-card">
        <div class="card-header-custom">
            <h5><i class="fas fa-plus-circle me-2"></i>Add Monthly Expense</h5>
        </div>
        <form id="addExpenseForm">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Expense Name *</label>
                    <input type="text" class="form-control" id="expenseName" required placeholder="e.g., Office Rent">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Amount (৳) *</label>
                    <input type="number" class="form-control" id="amount" step="0.01" required placeholder="0.00">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Month *</label>
                    <select class="form-select" id="month" required>
                        <option value="">Select Month</option>
                        <option value="1">January</option>
                        <option value="2">February</option>
                        <option value="3">March</option>
                        <option value="4">April</option>
                        <option value="5">May</option>
                        <option value="6">June</option>
                        <option value="7">July</option>
                        <option value="8">August</option>
                        <option value="9">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Year *</label>
                    <select class="form-select" id="year" required>
                        <!-- Will be populated by JavaScript -->
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">&nbsp;</label>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-plus-circle me-2"></i>Add Expense
                    </button>
                </div>
                <div class="col-md-12">
                    <label class="form-label">Description (Optional)</label>
                    <textarea class="form-control" id="description" rows="2" placeholder="Additional notes..."></textarea>
                </div>
            </div>
        </form>
    </div>

    <!-- Expenses List -->
    <div class="professional-card">
        <div class="card-header-custom">
            <h5><i class="fas fa-list me-2"></i>Monthly Expense Entries</h5>
        </div>
        <div id="expensesContainer">
            <div class="loading">
                <i class="fas fa-spinner"></i>
                <p class="mt-3">Loading expenses...</p>
            </div>
        </div>
    </div>
</div>

<script>
// Month names mapping
const monthNames = ['', 'January', 'February', 'March', 'April', 'May', 'June', 
                   'July', 'August', 'September', 'October', 'November', 'December'];

// Initialize year dropdown
function initializeYearDropdown() {
    const yearSelect = document.getElementById('year');
    const currentYear = new Date().getFullYear();
    
    for (let year = currentYear - 2; year <= currentYear + 5; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        if (year === currentYear) {
            option.selected = true;
        }
        yearSelect.appendChild(option);
    }
}

// Initialize month dropdown to current month
function initializeMonthDropdown() {
    const monthSelect = document.getElementById('month');
    const currentMonth = new Date().getMonth() + 1;
    monthSelect.value = currentMonth;
}

// Format currency
function formatCurrency(amount) {
    return '৳' + parseFloat(amount).toFixed(2);
}

// Load expenses
async function loadExpenses() {
    try {
        const response = await fetch('/api/sub-user/monthly-expenses');
        const data = await response.json();
        
        if (data.success) {
            displayExpenses(data.expenses);
            updateSummary(data.monthly_totals);
        } else {
            showError('Failed to load expenses');
        }
    } catch (error) {
        console.error('Error loading expenses:', error);
        showError('Error loading expenses');
    }
}

// Display expenses
function displayExpenses(expenses) {
    const container = document.getElementById('expensesContainer');
    
    if (expenses.length === 0) {
        container.innerHTML = `
            <div class="no-data">
                <i class="fas fa-inbox"></i>
                <h5>No Monthly Expenses Yet</h5>
                <p>Add your first monthly expense using the form above</p>
            </div>
        `;
        return;
    }
    
    // Group expenses by month and year
    const grouped = {};
    expenses.forEach(expense => {
        const key = `${expense.year}-${expense.month}`;
        if (!grouped[key]) {
            grouped[key] = {
                month: expense.month,
                year: expense.year,
                expenses: [],
                total: 0
            };
        }
        grouped[key].expenses.push(expense);
        grouped[key].total += parseFloat(expense.amount);
    });
    
    let html = '';
    Object.keys(grouped).sort().reverse().forEach(key => {
        const group = grouped[key];
        html += `
            <div class="mb-4">
                <h6 class="mb-3">
                    <span class="badge month-badge">${monthNames[group.month]} ${group.year}</span>
                    <span class="ms-2 text-muted">Total: ${formatCurrency(group.total)}</span>
                </h6>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Expense Name</th>
                                <th>Amount</th>
                                <th>Description</th>
                                <th>Date Added</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
        `;
        
        group.expenses.forEach(expense => {
            html += `
                <tr>
                    <td data-label="Expense Name">${expense.expense_name}</td>
                    <td data-label="Amount"><strong>${formatCurrency(expense.amount)}</strong></td>
                    <td data-label="Description">${expense.description || '-'}</td>
                    <td data-label="Date Added">${new Date(expense.created_at).toLocaleDateString()}</td>
                    <td data-label="Actions">
                        <button class="btn btn-danger btn-sm" onclick="deleteExpense(${expense.id})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </td>
                </tr>
            `;
        });
        
        html += `
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Update summary cards
function updateSummary(monthlyTotals) {
    const currentMonth = new Date().getMonth() + 1;
    const currentYear = new Date().getFullYear();
    
    // Find current month's total
    let monthlyTotal = 0;
    if (monthlyTotals && monthlyTotals.length > 0) {
        const currentMonthData = monthlyTotals.find(
            m => m.month === currentMonth && m.year === currentYear
        );
        if (currentMonthData) {
            monthlyTotal = parseFloat(currentMonthData.total);
        }
    }
    
    const yearlyTotal = monthlyTotal * 12;
    
    document.getElementById('monthlyTotal').textContent = formatCurrency(monthlyTotal);
    document.getElementById('yearlyTotal').textContent = formatCurrency(yearlyTotal);
}

// Add expense
document.getElementById('addExpenseForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData();
    formData.append('expense_name', document.getElementById('expenseName').value);
    formData.append('amount', document.getElementById('amount').value);
    formData.append('month', document.getElementById('month').value);
    formData.append('year', document.getElementById('year').value);
    formData.append('description', document.getElementById('description').value);
    
    try {
        const response = await fetch('/sub-user-monthly-expenses', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            showSuccess('Monthly expense added successfully');
            document.getElementById('addExpenseForm').reset();
            initializeMonthDropdown();
            loadExpenses();
        } else {
            showError(data.message || 'Failed to add expense');
        }
    } catch (error) {
        console.error('Error adding expense:', error);
        showError('Error adding expense');
    }
});

// Delete expense
async function deleteExpense(id) {
    if (!confirm('Are you sure you want to delete this monthly expense?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/sub-user/monthly-expenses/${id}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showSuccess('Monthly expense deleted successfully');
            loadExpenses();
        } else {
            showError(data.message || 'Failed to delete expense');
        }
    } catch (error) {
        console.error('Error deleting expense:', error);
        showError('Error deleting expense');
    }
}

// Show success message
function showSuccess(message) {
    // You can implement a toast notification here
    alert(message);
}

// Show error message
function showError(message) {
    // You can implement a toast notification here
    alert(message);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    initializeYearDropdown();
    initializeMonthDropdown();
    loadExpenses();
});
</script>

{% endblock %}

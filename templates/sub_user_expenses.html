{% extends "sub_user_base.html" %}

{% block title %}Sub User Expenses{% endblock %}

{% block content %}
<style>
/* Professional Confirmation Modal Styling */
#confirmationModal .modal-content {
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    border: none;
}

#confirmationModal .modal-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px 12px 0 0;
    padding: 20px 25px;
}

#confirmationModal .modal-title {
    font-weight: 600;
    font-size: 1.1rem;
}

#confirmationModal .confirmation-icon {
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
}

#confirmationModal .btn-close {
    filter: invert(1);
    opacity: 0.8;
}

#confirmationModal .btn-close:hover {
    opacity: 1;
}

#confirmationModal .modal-body {
    padding: 25px;
    font-size: 1rem;
    line-height: 1.5;
}

#confirmationModal .modal-footer {
    padding: 20px 25px 25px;
    gap: 10px;
}

#confirmationModal .btn {
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.2s ease;
}

#confirmationModal .btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
}

#confirmationModal .btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

#confirmationModal .btn-secondary {
    background: #6c757d;
    border: none;
}

#confirmationModal .btn-secondary:hover {
    background: #5a6268;
    transform: translateY(-1px);
}

#confirmationModal .confirmation-details .alert {
    border-radius: 8px;
    border: none;
    background: #fff3cd;
    border-left: 4px solid #ffc107;
}

#confirmationModal .confirmation-details h6 {
    color: #856404;
    font-weight: 600;
    margin-bottom: 10px;
}

/* Compact Table Styling - Same look, less spacing */
#expensesTable th,
#expensesTable td {
    padding: 6px 8px;
    font-size: 0.9rem;
}

#expensesTable thead th {
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
    font-weight: 600;
}

#expensesTable tbody tr:hover {
    background-color: #f8f9fa;
}

/* Notification Container Styles */
.notification-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
    max-width: 400px;
}

.notification-toast {
    margin-bottom: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border: none;
    border-radius: 8px;
}

.notification-toast .btn-close {
    padding: 0.5rem;
    margin: -0.5rem -0.5rem -0.5rem auto;
}
</style>

<div class="professional-dashboard">
    <!-- Header Section -->
    <div class="header-section">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center">
                <div class="page-header">
                    <!-- Removed title and subtitle -->
                </div>
                <div class="action-buttons">
                    <button class="btn btn-outline-secondary search-toggle-btn me-2" id="searchToggleBtn" onclick="toggleSearch()">
                        <i class="fas fa-search"></i>
                    </button>
                    <button type="button" class="btn btn-outline-primary me-2" onclick="loadExpenses()" title="Refresh expense status">
                        <i class="fas fa-sync-alt" id="refreshIcon"></i>
                    </button>
                    <button class="btn btn-outline-success btn-sm" id="bulkExportExpenses" style="display: none;" onclick="bulkExportExpenses()">
                        <i class="fas fa-file-pdf me-1"></i>Export Selected (<span id="selectedExpensesCount">0</span>)
                    </button>
                    <button class="btn btn-outline-danger btn-sm" id="bulkDeleteExpenses" style="display: none;" onclick="bulkDeleteExpenses()">
                        <i class="fas fa-trash me-1"></i>Delete Selected (<span id="selectedExpensesDeleteCount">0</span>)
                    </button>
                    <button class="btn btn-primary add-btn" data-bs-toggle="modal" data-bs-target="#expenseModal">
                        <i class="fas fa-plus me-2"></i>Add Expense Request
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="filters-section" id="filtersSection" style="display: none;">
        <div class="container-fluid">
            <div class="filter-card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="fas fa-filter me-2"></i>Filter Options
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-2">
                            <label for="filterUniqueId" class="form-label">Unique ID</label>
                            <input type="text" class="form-control" id="filterUniqueId" placeholder="Search by ID..." oninput="filterExpenses()" onkeyup="filterExpenses()">
                        </div>
                        <div class="col-md-2">
                            <label for="filterStatus" class="form-label">Status</label>
                            <select class="form-select" id="filterStatus" onchange="filterExpenses()">
                                <option value="">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="approved">Approved</option>
                                <option value="rejected">Rejected</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="filterCategory" class="form-label">Category</label>
                            <input type="text" class="form-control" id="filterCategory" placeholder="Category..." oninput="filterExpenses()" onkeyup="filterExpenses()">
                        </div>
                        <div class="col-md-2">
                            <label for="filterPaymentMethod" class="form-label">Payment Method</label>
                            <select class="form-select" id="filterPaymentMethod" onchange="filterExpenses()">
                                <option value="">All Methods</option>
                                <option value="cash">Cash</option>
                                <option value="online">Online</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="filterDateFrom" class="form-label">From Date</label>
                            <input type="date" class="form-control" id="filterDateFrom" onchange="filterExpenses()">
                        </div>
                        <div class="col-md-2">
                            <label for="filterDateTo" class="form-label">To Date</label>
                            <input type="date" class="form-control" id="filterDateTo" onchange="filterExpenses()">
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-2">
                            <button class="btn btn-outline-secondary w-100" onclick="clearExpenseFilters()">
                                <i class="fas fa-times me-1"></i>Clear Filters
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Expenses Table Section -->
    <div class="table-section">
        <div class="container-fluid">
            <div class="table-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title">
                        <i class="fas fa-list me-2"></i>Expense Requests
                        <span class="badge bg-primary ms-2" id="expenseCount">0</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table class="detail-table" id="expensesTable">
                            <thead>
                                <tr>
                                    <th>
                                        <input type="checkbox" id="selectAllExpenses" class="form-check-input" title="Select All">
                                    </th>
                                    <th>Unique ID</th>
                                    <th>Purpose</th>
                                    <th>Amount</th>
                                    <th>Category</th>
                                    <th>Payment Method</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="empty-state" id="noExpenses" style="display: none;">
                        <div class="empty-icon">
                            <i class="fas fa-receipt"></i>
                        </div>
                        <h4>No Expense Requests Found</h4>
                        <p>Start by submitting your first expense request.</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#expenseModal">
                            <i class="fas fa-plus me-2"></i>Add First Request
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Expense Modal -->
<div class="modal fade" id="expenseModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content professional-modal">
            <div class="modal-header">
                <h5 class="modal-title" id="expenseModalTitle">
                    <i class="fas fa-plus me-2"></i>Add Expense Request
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="expenseForm" enctype="multipart/form-data">
                    <input type="hidden" id="expenseId" name="expense_id">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="expensePurpose" class="form-label">Purpose of Expense *</label>
                            <input type="text" class="form-control" id="expensePurpose" name="purpose" required>
                        </div>
                        <div class="col-md-6">
                            <label for="expenseAmount" class="form-label">Amount *</label>
                            <div class="input-group">
                                <span class="input-group-text">₹</span>
                                <input type="number" class="form-control" id="expenseAmount" name="amount" step="0.01" min="0" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="expensePaymentMethod" class="form-label">Payment Method *</label>
                            <select class="form-select" id="expensePaymentMethod" name="payment_method" required onchange="toggleBankSelection()">
                                <option value="cash">Cash</option>
                                <option value="online">Online</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="expensePaymentType" class="form-label">Payment Type *</label>
                            <select class="form-select" id="expensePaymentType" name="payment_type" required onchange="toggleInvoiceRequirement()">
                                <option value="">Select Payment Type</option>
                                <option value="invoice">Invoice</option>
                                <option value="non_invoice">Non Invoice</option>
                            </select>
                        </div>
                        <div class="col-md-6" id="bankSelectionDiv" style="display: none;">
                            <label for="expenseBankAccountType" class="form-label">Bank Account Type *</label>
                            <select class="form-select" id="expenseBankAccountType" name="bank_account_type" onchange="toggleBankAccountDetails()">
                                <option value="">Select account type...</option>
                                <option value="own">Own Account</option>
                                <option value="vendor">Vendor Account</option>
                            </select>
                        </div>
                        <div class="col-md-6" id="bankAccountDetailsDiv" style="display: none;">
                            <label for="expenseBankAccount" class="form-label">Bank Account *</label>
                            <select class="form-select" id="expenseBankAccount" name="bank_account_id">
                                <option value="">Choose a bank account...</option>
                            </select>
                        </div>
                        <div class="col-12" id="vendorBankDetailsDiv" style="display: none;">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-university me-2"></i>Vendor Bank Details
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label for="vendorBankName" class="form-label">Vendor Bank Name *</label>
                                            <input type="text" class="form-control" id="vendorBankName" name="vendor_bank_name" placeholder="e.g. State Bank of India">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="vendorAccountNumber" class="form-label">Vendor Account Number *</label>
                                            <input type="text" class="form-control" id="vendorAccountNumber" name="vendor_account_number" placeholder="e.g. 1234567890">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="vendorIfscCode" class="form-label">Vendor IFSC Code *</label>
                                            <input type="text" class="form-control" id="vendorIfscCode" name="vendor_ifsc_code" placeholder="e.g. SBIN0001234">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="vendorAccountHolderName" class="form-label">Vendor Account Holder Name *</label>
                                            <input type="text" class="form-control" id="vendorAccountHolderName" name="vendor_account_holder_name" placeholder="Vendor's full name">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="vendorUpiId" class="form-label">Vendor UPI ID</label>
                                            <input type="text" class="form-control" id="vendorUpiId" name="vendor_upi_id" placeholder="e.g. vendor@upi">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="vendorPhoneNumber" class="form-label">Vendor Phone Number</label>
                                            <input type="text" class="form-control" id="vendorPhoneNumber" name="vendor_phone_number" placeholder="e.g. +91 9876543210">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="expenseCategory" class="form-label">Category</label>
                            <input type="text" class="form-control" id="expenseCategory" name="category" list="categoryOptions">
                            <datalist id="categoryOptions">
                                <option value="Office Supplies">
                                <option value="Travel">
                                <option value="Meals">
                                <option value="Marketing">
                                <option value="Utilities">
                                <option value="Other">
                            </datalist>
                        </div>
                        <div class="col-md-6">
                            <label for="expenseType" class="form-label">Type</label>
                            <select class="form-select" id="expenseType" name="expense_type">
                                <option value="current">Current</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="expenseDate" class="form-label">Date *</label>
                            <input type="date" class="form-control" id="expenseDate" name="expense_date" required>
                        </div>
                        <div class="col-md-6">
                            <label for="billFile" class="form-label">Bill/Receipt</label>
                            <input type="file" class="form-control" id="billFile" name="bill_file" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
                            <div class="form-text" id="billHelpText">Optional. Supported formats: PDF, Images, Word documents</div>
                            <span id="billRequired" class="text-danger" style="display: none;">*</span>
                        </div>
                        <div class="col-12">
                            <label for="expenseDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="expenseDescription" name="description" rows="3" placeholder="Additional details about the expense..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveExpense()">
                    <i class="fas fa-save me-2"></i>Save Request
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
console.log('=== EXPENSES SCRIPT BLOCK LOADED ===');

// Global error handler
window.addEventListener('error', function(e) {
    console.error('JavaScript Error:', e.error);
    console.error('Error details:', e.filename, e.lineno, e.colno);
    showAlert('JavaScript Error: ' + e.message, 'danger');
});

// Global variables
let editingExpenseId = null;
let allExpenses = [];
let filteredExpenses = [];



// Show alert function
function showAlert(message, type) {
    // Create notification container if it doesn't exist
    let notificationContainer = document.querySelector('.notification-container');
    if (!notificationContainer) {
        notificationContainer = document.createElement('div');
        notificationContainer.className = 'notification-container';
        document.body.appendChild(notificationContainer);
    }
    
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show notification-toast`;
    alertDiv.setAttribute('role', 'alert');
    
    // Add icon based on type
    let icon = '';
    switch(type) {
        case 'success':
            icon = '<i class="fas fa-check-circle me-2"></i>';
            break;
        case 'danger':
            icon = '<i class="fas fa-exclamation-circle me-2"></i>';
            break;
        case 'warning':
            icon = '<i class="fas fa-exclamation-triangle me-2"></i>';
            break;
        case 'info':
            icon = '<i class="fas fa-info-circle me-2"></i>';
            break;
    }
    
    alertDiv.innerHTML = `
        ${icon}${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    // Add to notification container
    notificationContainer.appendChild(alertDiv);
    
    // Auto remove after 4 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.classList.remove('show');
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 300);
        }
    }, 4000);
}







// Toggle bank selection based on payment method
function toggleBankSelection() {
    const paymentMethod = document.getElementById('expensePaymentMethod').value;
    const bankDiv = document.getElementById('bankSelectionDiv');
    const bankAccountDetailsDiv = document.getElementById('bankAccountDetailsDiv');
    const vendorBankDetailsDiv = document.getElementById('vendorBankDetailsDiv');
    
    if (paymentMethod === 'online') {
        bankDiv.style.display = 'block';
    } else {
        bankDiv.style.display = 'none';
        bankAccountDetailsDiv.style.display = 'none';
        vendorBankDetailsDiv.style.display = 'none';
        // Reset form fields
        document.getElementById('expenseBankAccountType').value = '';
        document.getElementById('expenseBankAccount').innerHTML = '<option value="">Choose a bank account...</option>';
    }
}

// Toggle bank account details based on account type
function toggleBankAccountDetails() {
    const accountType = document.getElementById('expenseBankAccountType').value;
    const bankAccountDetailsDiv = document.getElementById('bankAccountDetailsDiv');
    const vendorBankDetailsDiv = document.getElementById('vendorBankDetailsDiv');
    
    if (accountType === 'own') {
        bankAccountDetailsDiv.style.display = 'block';
        vendorBankDetailsDiv.style.display = 'none';
        loadOwnBankAccount();
        clearVendorBankDetails();
    } else if (accountType === 'vendor') {
        bankAccountDetailsDiv.style.display = 'none';
        vendorBankDetailsDiv.style.display = 'block';
        clearOwnBankAccount();
    } else {
        bankAccountDetailsDiv.style.display = 'none';
        vendorBankDetailsDiv.style.display = 'none';
        clearOwnBankAccount();
        clearVendorBankDetails();
    }
}

// Load own bank account (sub user's bank account)
function loadOwnBankAccount() {
    const bankSelect = document.getElementById('expenseBankAccount');
    
    fetch('/api/sub-user/bank-account')
    .then(response => response.json())
    .then(data => {
        bankSelect.innerHTML = '<option value="">Choose a bank account...</option>';
        
        if (data.success && data.bank_account) {
            const account = data.bank_account;
            const option = document.createElement('option');
            option.value = 'own_account';
            option.textContent = `${account.bank_name} - ${account.account_number}`;
            bankSelect.appendChild(option);
        } else {
            bankSelect.innerHTML = '<option value="">No bank account found. Please add one in Settings.</option>';
        }
    })
    .catch(error => {
        console.error('Error loading own bank account:', error);
        bankSelect.innerHTML = '<option value="">Error loading bank account</option>';
    });
}

// Clear own bank account selection
function clearOwnBankAccount() {
    document.getElementById('expenseBankAccount').innerHTML = '<option value="">Choose a bank account...</option>';
}

// Clear vendor bank details
function clearVendorBankDetails() {
    document.getElementById('vendorBankName').value = '';
    document.getElementById('vendorAccountNumber').value = '';
    document.getElementById('vendorIfscCode').value = '';
    document.getElementById('vendorAccountHolderName').value = '';
    document.getElementById('vendorUpiId').value = '';
    document.getElementById('vendorPhoneNumber').value = '';
}

// Toggle invoice requirement based on payment type
function toggleInvoiceRequirement() {
    const paymentType = document.getElementById('expensePaymentType').value;
    const billRequired = document.getElementById('billRequired');
    const billHelpText = document.getElementById('billHelpText');
    
    if (paymentType === 'invoice') {
        billRequired.style.display = 'inline';
        billHelpText.textContent = 'Required for invoice payments. Supported formats: PDF, Images, Word documents';
    } else {
        billRequired.style.display = 'none';
        billHelpText.textContent = 'Optional. Supported formats: PDF, Images, Word documents';
    }
}

// Load bank accounts
function loadBankAccounts() {
    const bankSelect = document.getElementById('expenseBankAccount');
    
    fetch('/api/sub-user/banks')
    .then(response => response.json())
    .then(data => {
        bankSelect.innerHTML = '<option value="">Choose a bank account...</option>';
        
        if (data && data.length > 0) {
            data.forEach(account => {
                const option = document.createElement('option');
                option.value = account.id;
                option.textContent = `${account.bank_name} - ${account.account_number}`;
                bankSelect.appendChild(option);
            });
        } else {
            bankSelect.innerHTML = '<option value="">No bank accounts available</option>';
        }
    })
    .catch(error => {
        console.error('Error loading bank accounts:', error);
        bankSelect.innerHTML = '<option value="">Error loading bank accounts</option>';
    });
}

// Save expense function
async function saveExpense() {
    try {
        const form = document.getElementById('expenseForm');
        const formData = new FormData(form);
        
        // Client-side validation
        const purpose = document.getElementById('expensePurpose').value.trim();
        const amount = document.getElementById('expenseAmount').value;
        const paymentMethod = document.getElementById('expensePaymentMethod').value;
        const paymentType = document.getElementById('expensePaymentType').value;
        const bankAccountType = document.getElementById('expenseBankAccountType').value;
        const bankAccount = document.getElementById('expenseBankAccount').value;
        
        if (!purpose) {
            alert('Please enter the purpose of expense');
            return;
        }
        
        if (!amount || parseFloat(amount) <= 0) {
            alert('Please enter a valid amount');
            return;
        }
        
        if (!paymentType) {
            alert('Please select a payment type');
            return;
        }
        
        if (paymentMethod === 'online') {
            if (!bankAccountType) {
                alert('Please select a bank account type for online payments');
                return;
            }
            
            if (bankAccountType === 'own' && !bankAccount) {
                alert('Please select your bank account for online payments');
                return;
            }
            
            if (bankAccountType === 'vendor') {
                const vendorBankName = document.getElementById('vendorBankName').value.trim();
                const vendorAccountNumber = document.getElementById('vendorAccountNumber').value.trim();
                const vendorIfscCode = document.getElementById('vendorIfscCode').value.trim();
                const vendorAccountHolderName = document.getElementById('vendorAccountHolderName').value.trim();
                
                if (!vendorBankName || !vendorAccountNumber || !vendorIfscCode || !vendorAccountHolderName) {
                    alert('Please fill in all required vendor bank details');
                    return;
                }
            }
        }
        
        const isEdit = editingExpenseId !== null;
        const url = isEdit ? `/api/sub-user/expense-requests/${editingExpenseId}` : '/api/sub-user/expense-requests';
        const method = isEdit ? 'PUT' : 'POST';
        
        // Convert FormData to JSON for sub-user API
        const requestData = {
            title: formData.get('purpose'),
            description: formData.get('description') || '',
            amount: parseFloat(formData.get('amount')),
            category: formData.get('category') || '',
            expense_date: formData.get('expense_date'),
            payment_method: formData.get('payment_method'),
            payment_type: formData.get('payment_type'),
            bank_account_type: formData.get('bank_account_type') || null,
            bank_account_id: formData.get('bank_account_id') || null,
            expense_type: formData.get('expense_type') || 'completed'
        };
        
        // Add vendor bank details if vendor account is selected
        if (bankAccountType === 'vendor') {
            requestData.vendor_bank_details = {
                bank_name: formData.get('vendor_bank_name'),
                account_number: formData.get('vendor_account_number'),
                ifsc_code: formData.get('vendor_ifsc_code'),
                account_holder_name: formData.get('vendor_account_holder_name'),
                upi_id: formData.get('vendor_upi_id') || '',
                phone_number: formData.get('vendor_phone_number') || ''
            };
        }
        
        const response = await fetch(url, {
            method: method,
            body: JSON.stringify(requestData),
            headers: { 'Content-Type': 'application/json' }
        });
        
        if (response.ok) {
            const result = await response.json();
            triggerNotification(result.message || (isEdit ? 'Expense updated successfully' : 'Expense request submitted successfully'), 'success');
            
            // Close modal and reset form
            const modal = bootstrap.Modal.getInstance(document.getElementById('expenseModal'));
            modal.hide();
            resetExpenseForm();
            
            // Reload expenses
            loadExpenses();
        } else {
            const error = await response.json();
            triggerNotification(error.error || 'An error occurred while saving the expense', 'error');
        }
    } catch (error) {
        console.error('Error saving expense:', error);
        triggerNotification('An unexpected error occurred. Please try again.', 'error');
    }
}

// Select all functionality
function initializeSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAllExpenses');
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            try {
                const checkboxes = document.querySelectorAll('.expense-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
                updateBulkButtons();
                console.log(`Select all: ${this.checked ? 'checked' : 'unchecked'}`);
            } catch (error) {
                console.error('Error in select all:', error);
                showAlert('Error in select all functionality: ' + error.message, 'danger');
            }
        });
    }
}

// Global variable to store previous expenses for comparison
let previousExpenses = [];

// Load expenses with real-time status checking
async function loadExpenses() {
    try {
        console.log('Loading expenses...');
        
        // Show spinning icon during refresh
        const refreshIcon = document.getElementById('refreshIcon');
        if (refreshIcon) {
            refreshIcon.classList.add('fa-spin');
        }
        
        // Add cache busting and no-cache headers for real-time updates
        const response = await fetch(`/api/sub-user/expense-requests?_t=${Date.now()}`, {
            cache: 'no-store',
            headers: {
                'Cache-Control': 'no-cache'
            }
        });
        console.log('Response status:', response.status);
        
        if (response.ok) {
            const data = await response.json();
            console.log('Expense data:', data);
            const newExpenses = data.requests || [];
            console.log('Loaded expenses:', newExpenses);
            
            // Check for status changes and notify user
            if (previousExpenses.length > 0) {
                newExpenses.forEach(newExpense => {
                    const oldExpense = previousExpenses.find(old => old.id === newExpense.id);
                    if (oldExpense && oldExpense.status !== newExpense.status) {
                        const statusText = newExpense.status === 'approved' ? 'Approved' :
                                         newExpense.status === 'rejected' ? 'Rejected' : 'Pending';
                        triggerNotification(`Expense "${newExpense.title}" status updated to: ${statusText}`,
                                           newExpense.status === 'approved' ? 'success' :
                                           newExpense.status === 'rejected' ? 'error' : 'info');
                    }
                });
            }
            
            previousExpenses = [...newExpenses]; // Store current state for next comparison
            allExpenses = newExpenses;
            
            // If no expenses found, show a helpful message
            if (allExpenses.length === 0) {
                console.log('No expenses found for this sub user');
            }
            
            filteredExpenses = [...allExpenses];
            displayExpenses(filteredExpenses);
            updateExpenseSummaryCards();
        } else {
            console.error('Failed to load expenses, status:', response.status);
            const errorText = await response.text();
            console.error('Error response:', errorText);
            
            // Show error in the UI
            const tbody = document.querySelector('#expensesTable tbody');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error loading expenses (Status: ' + response.status + ')</td></tr>';
            }
            
            // Show alert notification
            showAlert(`Failed to load expenses: ${response.status} - ${errorText}`, 'danger');
            
            // Show empty state
            displayExpenses([]);
        }
    } catch (error) {
        console.error('Error loading expenses:', error);
        
        // Show error in the UI
        const tbody = document.querySelector('#expensesTable tbody');
        if (tbody) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error loading expenses: ' + error.message + '</td></tr>';
        }
        
        // Show alert notification
        showAlert(`Connection Error: ${error.message}`, 'danger');
        
        // Show empty state
        displayExpenses([]);
    } finally {
        // Stop spinning icon
        const refreshIcon = document.getElementById('refreshIcon');
        if (refreshIcon) {
            refreshIcon.classList.remove('fa-spin');
        }
    }
}

// Display expenses in table
function displayExpenses(expenses) {
    const tbody = document.querySelector('#expensesTable tbody');
    const noExpensesDiv = document.getElementById('noExpenses');
    const countBadge = document.getElementById('expenseCount');
    
    if (!tbody || !noExpensesDiv || !countBadge) {
        console.error('Required elements not found for displayExpenses');
        return;
    }
    
    countBadge.textContent = expenses.length;
    
    if (expenses.length === 0) {
        document.getElementById('expensesTable').style.display = 'none';
        noExpensesDiv.style.display = 'block';
        return;
    }
    
    document.getElementById('expensesTable').style.display = 'table';
    noExpensesDiv.style.display = 'none';
    
    tbody.innerHTML = expenses.map(expense => {
        // Handle potential null or undefined values
        const title = expense.title || '-';
        const amount = parseFloat(expense.amount) || 0;
        const category = expense.category || '-';
        const paymentMethod = expense.payment_method || 'cash';
        const expenseDate = expense.expense_date || expense.created_at || null;
        const status = expense.status || 'unknown';
        
        // Format date properly
        let dateStr = '-';
        if (expenseDate) {
            try {
                const date = new Date(expenseDate);
                if (!isNaN(date.getTime())) {
                    dateStr = date.toLocaleDateString();
                }
            } catch (e) {
                console.error('Error formatting date:', e);
                dateStr = '-';
            }
        }
        
        // Determine status badge with icons (similar to invoices)
        let statusBadge = '';
        switch (status.toLowerCase()) {
            case 'pending':
                statusBadge = '<span class="badge bg-warning"><i class="fas fa-clock me-1"></i>Pending</span>';
                break;
            case 'approved':
                statusBadge = '<span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>Approved</span>';
                break;
            case 'rejected':
                statusBadge = '<span class="badge bg-danger"><i class="fas fa-times-circle me-1"></i>Rejected</span>';
                break;
            default:
                statusBadge = '<span class="badge bg-secondary"><i class="fas fa-question-circle me-1"></i>Unknown</span>';
        }
        
        // Handle unique ID
        const uniqueId = expense.unique_id || '-';
        const uniqueIdDisplay = uniqueId !== '-' ? 
            `<code class="text-primary">${uniqueId}</code>` : 
            '<span class="text-muted">-</span>';
        

        return `
            <tr>
                <td>
                    <input type="checkbox" class="form-check-input expense-checkbox" value="${expense.id}" onchange="updateBulkButtons()">
                </td>
                <td>${uniqueIdDisplay}</td>
                <td><strong>${title}</strong></td>
                <td><strong>₹${amount.toFixed(2)}</strong></td>
                <td>${category}</td>
                <td><span class="badge bg-${paymentMethod === 'online' ? 'success' : 'secondary'}">${paymentMethod.toUpperCase()}</span></td>
                <td>${dateStr}</td>
                <td>${statusBadge}</td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-danger" onclick="deleteExpense('${expense.id}')" title="Delete Expense">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}




// Professional Confirmation Modal Functions
function showConfirmationModal(options) {
    const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
    
    // Set modal content
    document.getElementById('confirmationTitle').textContent = options.title || 'Confirm Action';
    document.getElementById('confirmationMessage').textContent = options.message || 'Are you sure you want to proceed?';
    
    // Set icon based on type
    const icon = document.querySelector('#confirmationModal .confirmation-icon i');
    if (options.type === 'delete') {
        icon.className = 'fas fa-trash-alt';
        document.getElementById('confirmationConfirmBtn').className = 'btn btn-danger';
        document.getElementById('confirmationConfirmBtn').innerHTML = '<i class="fas fa-trash me-2"></i>Delete';
    } else if (options.type === 'approve') {
        icon.className = 'fas fa-check-circle';
        document.getElementById('confirmationConfirmBtn').className = 'btn btn-success';
        document.getElementById('confirmationConfirmBtn').innerHTML = '<i class="fas fa-check me-2"></i>Approve';
    } else {
        icon.className = 'fas fa-question-circle';
        document.getElementById('confirmationConfirmBtn').className = 'btn btn-primary';
        document.getElementById('confirmationConfirmBtn').innerHTML = '<i class="fas fa-check me-2"></i>Confirm';
    }
    
    // Show request details if provided
    if (options.requestDetails) {
        document.getElementById('confirmationDetails').style.display = 'block';
        document.getElementById('confirmationRequestInfo').innerHTML = options.requestDetails;
    } else {
        document.getElementById('confirmationDetails').style.display = 'none';
    }
    
    // Set up confirm button action
    const confirmBtn = document.getElementById('confirmationConfirmBtn');
    confirmBtn.onclick = options.onConfirm;
    
    // Show modal
    modal.show();
}

// Delete individual expense with professional modal
async function deleteExpense(expenseId) {
    try {
        // Convert string ID to integer for real expenses
        const numericId = parseInt(expenseId);
        if (isNaN(numericId)) {
            showAlert('Invalid expense ID', 'danger');
            return;
        }
        
        // Find the expense data to show details
        console.log('Looking for expense with ID:', numericId);
        console.log('Available expenses:', allExpenses);
        const expense = allExpenses.find(e => e.id === numericId);
        let expenseDetails = '';
        
        if (expense) {
            expenseDetails = `
                <div class="row">
                    <div class="col-6"><strong>Title:</strong> ${expense.title || 'N/A'}</div>
                    <div class="col-6"><strong>Amount:</strong> ₹${parseFloat(expense.amount || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}</div>
                    <div class="col-6"><strong>Category:</strong> ${expense.category || 'N/A'}</div>
                    <div class="col-6"><strong>Date:</strong> ${new Date(expense.expense_date || expense.created_at).toLocaleDateString()}</div>
                    <div class="col-12"><strong>Description:</strong> ${expense.description || 'No description provided'}</div>
                </div>
                <div class="mt-3">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Warning:</strong> This action will adjust account balances and add money back to credit. This action cannot be undone.
                    </div>
                </div>
            `;
        } else {
            console.warn('Expense not found with ID:', expenseId);
            expenseDetails = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> Expense details could not be loaded. Proceeding with deletion.
                </div>
            `;
        }
        
        showConfirmationModal({
            type: 'delete',
            title: 'Delete Expense',
            message: 'Are you sure you want to delete this expense? This action cannot be undone.',
            requestDetails: expenseDetails,
            onConfirm: async function() {
                console.log('User confirmed deletion for expense:', numericId);
                
                // Close modal first
                const modal = bootstrap.Modal.getInstance(document.getElementById('confirmationModal'));
                modal.hide();
                
                // Show loading state
                showAlert('Deleting expense...', 'info');
                
                try {
                    console.log('Deleting expense:', numericId);
                    
                    const response = await fetch(`/api/sub-user/expense-requests/${numericId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok && result.success) {
                        showAlert(result.message, 'success');
                        console.log('Delete result:', result);
                        
                        // Reload expenses
                        loadExpenses();
                    } else {
                        throw new Error(result.message || 'Failed to delete expense');
                    }
                    
                } catch (error) {
                    console.error('Error deleting expense:', error);
                    showAlert('Error deleting expense: ' + error.message, 'danger');
                }
            }
        });
        
    } catch (error) {
        console.error('Error in deleteExpense function:', error);
        showAlert('Error preparing delete confirmation: ' + error.message, 'danger');
    }
}

// Update bulk action buttons based on selected checkboxes
function updateBulkButtons() {
    const checkboxes = document.querySelectorAll('.expense-checkbox:checked');
    const bulkDeleteBtn = document.getElementById('bulkDeleteExpenses');
    const bulkExportBtn = document.getElementById('bulkExportExpenses');
    const selectedCount = document.getElementById('selectedExpensesCount');
    const selectedDeleteCount = document.getElementById('selectedExpensesDeleteCount');
    
    if (!bulkDeleteBtn || !bulkExportBtn) {
        console.error('Bulk action buttons not found');
        return;
    }
    
    const count = checkboxes.length;
    if (selectedCount) selectedCount.textContent = count;
    if (selectedDeleteCount) selectedDeleteCount.textContent = count;
    
    const showButtons = count > 0;
    bulkDeleteBtn.style.display = showButtons ? 'inline-block' : 'none';
    bulkExportBtn.style.display = showButtons ? 'inline-block' : 'none';
}

// Bulk export expenses as PDF
async function bulkExportExpenses() {
    try {
        const selectedCheckboxes = document.querySelectorAll('.expense-checkbox:checked');
        const selectedIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));
        
        if (selectedIds.length === 0) {
            showAlert('No expenses selected for export.', 'warning');
            return;
        }
        
        console.log('Exporting expenses:', selectedIds);
        
        const exportBtn = document.getElementById('bulkExportExpenses');
        const originalText = exportBtn.innerHTML;
        exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Exporting...';
        exportBtn.disabled = true;
        
        // Create a form to submit the selected IDs
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/api/sub-user/expenses/export';
        form.style.display = 'none';
        
        // Add selected IDs as hidden inputs
        selectedIds.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'expense_ids';
            input.value = id;
            form.appendChild(input);
        });
        
        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);
        
        showAlert(`Exporting ${selectedIds.length} selected expense(s) to PDF...`, 'success');
        
        // Reset button after a delay
        setTimeout(() => {
            exportBtn.innerHTML = originalText;
            exportBtn.disabled = false;
        }, 2000);
        
    } catch (error) {
        console.error('Error exporting expenses:', error);
        showAlert('Error exporting expenses: ' + error.message, 'danger');
        
        const exportBtn = document.getElementById('bulkExportExpenses');
        exportBtn.innerHTML = '<i class="fas fa-file-pdf me-1"></i>Export Selected (<span id="selectedExpensesCount">0</span>)';
        exportBtn.disabled = false;
    }
}

// Bulk delete selected expenses
async function bulkDeleteExpenses() {
    try {
        const selectedCheckboxes = document.querySelectorAll('.expense-checkbox:checked');
        const selectedIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));
        
        if (selectedIds.length === 0) {
            showAlert('No expenses selected for deletion.', 'warning');
            return;
        }
        
        const confirmed = confirm(
            `Are you sure you want to delete ${selectedIds.length} selected expense(s)? This will adjust account balances and add money back to credit. This action cannot be undone.`
        );
        
        if (!confirmed) {
            return;
        }
        
        console.log('Bulk deleting expenses:', selectedIds);
        
        const deleteBtn = document.getElementById('bulkDeleteExpenses');
        const originalText = deleteBtn.innerHTML;
        deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Deleting...';
        deleteBtn.disabled = true;
        
        // Use the bulk delete endpoint
        const response = await fetch('/api/sub-user/expense-requests/bulk-delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                expense_ids: selectedIds
            })
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            showAlert(result.message, 'success');
            console.log('Bulk delete result:', result);
        } else {
            throw new Error(result.message || 'Failed to delete expenses');
        }
        
        // Reset select all checkbox
        document.getElementById('selectAllExpenses').checked = false;
        
        // Reload expenses
        loadExpenses();
        
        // Reset button
        deleteBtn.innerHTML = originalText;
        deleteBtn.disabled = false;
        
    } catch (error) {
        console.error('Error in bulk delete:', error);
        showAlert('Error deleting expenses: ' + error.message, 'danger');
        
        const deleteBtn = document.getElementById('bulkDeleteExpenses');
        deleteBtn.innerHTML = '<i class="fas fa-trash me-1"></i>Delete Selected (<span id="selectedExpensesDeleteCount">0</span>)';
        deleteBtn.disabled = false;
    }
}

// Toggle search/filter section
function toggleSearch() {
    try {
        const filtersSection = document.getElementById('filtersSection');
        const searchToggleBtn = document.getElementById('searchToggleBtn');
        
        if (!filtersSection || !searchToggleBtn) {
            console.error('Required elements not found for toggleSearch');
            showAlert('Error: Filter elements not found', 'danger');
            return;
        }
        
        if (filtersSection.style.display === 'none' || filtersSection.style.display === '') {
            filtersSection.style.display = 'block';
            searchToggleBtn.classList.add('active');
        } else {
            filtersSection.style.display = 'none';
            searchToggleBtn.classList.remove('active');
        }
    } catch (error) {
        console.error('Error in toggleSearch:', error);
        showAlert('Error toggling search: ' + error.message, 'danger');
    }
}

// Filter expenses based on search criteria
function filterExpenses() {
    const uniqueId = document.getElementById('filterUniqueId').value.toLowerCase();
    const status = document.getElementById('filterStatus').value.toLowerCase();
    const category = document.getElementById('filterCategory').value.toLowerCase();
    const paymentMethod = document.getElementById('filterPaymentMethod').value.toLowerCase();
    const dateFrom = document.getElementById('filterDateFrom').value;
    const dateTo = document.getElementById('filterDateTo').value;
    
    // Check if we have data to filter
    if (!allExpenses || allExpenses.length === 0) {
        console.log('No expenses to filter!');
        showAlert('No expenses available to filter', 'warning');
        return;
    }
    
    filteredExpenses = allExpenses.filter(expense => {
        const expenseUniqueId = expense.unique_id || '';
        const expenseNotes = expense.notes || '';
        
        // Search in both unique_id field and notes field (as fallback)
        const matchesUniqueId = !uniqueId || 
            (expenseUniqueId && expenseUniqueId.toLowerCase().includes(uniqueId)) ||
            (expenseNotes && expenseNotes.toLowerCase().includes(uniqueId));
        
        const matchesStatus = !status || (expense.status && expense.status.toLowerCase().includes(status));
        const matchesCategory = !category || (expense.category && expense.category.toLowerCase().includes(category));
        const matchesPaymentMethod = !paymentMethod || (expense.payment_method && expense.payment_method.toLowerCase().includes(paymentMethod));
        
        let matchesDateRange = true;
        if (dateFrom || dateTo) {
            const expenseDate = new Date(expense.expense_date || expense.created_at);
            if (dateFrom && expenseDate < new Date(dateFrom)) matchesDateRange = false;
            if (dateTo && expenseDate > new Date(dateTo)) matchesDateRange = false;
        }
        
        return matchesUniqueId && matchesStatus && matchesCategory && matchesPaymentMethod && matchesDateRange;
    });
    
    displayExpenses(filteredExpenses);
}

// Clear all filters
function clearExpenseFilters() {
    try {
        document.getElementById('filterUniqueId').value = '';
        document.getElementById('filterStatus').value = '';
        document.getElementById('filterCategory').value = '';
        document.getElementById('filterPaymentMethod').value = '';
        document.getElementById('filterDateFrom').value = '';
        document.getElementById('filterDateTo').value = '';
        filteredExpenses = [...allExpenses];
        displayExpenses(filteredExpenses);
        showAlert('Filters cleared successfully!', 'info');
    } catch (error) {
        console.error('Error clearing filters:', error);
        showAlert('Error clearing filters: ' + error.message, 'danger');
    }
}

// Reset expense form
function resetExpenseForm() {
    document.getElementById('expenseForm').reset();
    document.getElementById('expenseDate').valueAsDate = new Date();
    document.getElementById('expensePaymentMethod').value = 'cash';
    document.getElementById('expensePaymentType').value = 'non_invoice';
    document.getElementById('expenseType').value = 'completed';
    document.getElementById('bankSelectionDiv').style.display = 'none';
    document.getElementById('bankAccountDetailsDiv').style.display = 'none';
    document.getElementById('vendorBankDetailsDiv').style.display = 'none';
    document.getElementById('expenseBankAccountType').value = '';
    document.getElementById('expenseBankAccount').value = '';
    clearVendorBankDetails();
    editingExpenseId = null;
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== EXPENSES PAGE INITIALIZATION START ===');
    console.log('Expenses page loaded, initializing...');
    
    try {
        // Set default date to today
        const today = new Date();
        const formattedDate = today.toISOString().split('T')[0];
        document.getElementById('expenseDate').value = formattedDate;
        
        document.getElementById('expensePaymentMethod').value = 'cash';
        document.getElementById('expensePaymentType').value = 'non_invoice';
        document.getElementById('expenseType').value = 'completed';
        document.getElementById('bankSelectionDiv').style.display = 'none';
        document.getElementById('bankAccountDetailsDiv').style.display = 'none';
        document.getElementById('vendorBankDetailsDiv').style.display = 'none';
        document.getElementById('expenseBankAccountType').value = '';
        document.getElementById('expenseBankAccount').value = '';
        
        console.log('Form initialized, loading expenses...');
        
        // Initialize select all functionality
        initializeSelectAll();
        
        // Load initial data
        loadExpenses().catch(error => {
            console.error('Error loading expenses on page load:', error);
            const tbody = document.querySelector('#expensesTable tbody');
            tbody.innerHTML = '<tr><td colspan="9" class="text-center">Error loading expenses. Please try refreshing the page.</td></tr>';
        });
        
        console.log('=== EXPENSES PAGE INITIALIZATION COMPLETE ===');
    } catch (error) {
        console.error('Error during page initialization:', error);
        alert('Error during page initialization: ' + error.message);
    }
});

// Update expense summary cards
function updateExpenseSummaryCards() {
    if (!allExpenses || allExpenses.length === 0) return;
    
    const totalExpenses = allExpenses.length;
    const approvedExpenses = allExpenses.filter(exp => exp.status === 'approved');
    const pendingExpenses = allExpenses.filter(exp => exp.status === 'pending');
    const rejectedExpenses = allExpenses.filter(exp => exp.status === 'rejected');
    
    const approvedAmount = approvedExpenses.reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
    const pendingAmount = pendingExpenses.reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
    const rejectedAmount = rejectedExpenses.reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
    
    // Update UI if summary cards exist
    const totalCard = document.querySelector('.card:nth-child(1) .card-body h3');
    const approvedCard = document.querySelector('.card:nth-child(2) .card-body h3');
    const pendingCard = document.querySelector('.card:nth-child(3) .card-body h3');
    const rejectedCard = document.querySelector('.card:nth-child(4) .card-body h3');
    
    if (totalCard) totalCard.textContent = totalExpenses;
    if (approvedCard) approvedCard.textContent = approvedExpenses.length;
    if (pendingCard) pendingCard.textContent = pendingExpenses.length;
    if (rejectedCard) rejectedCard.textContent = rejectedExpenses.length;
    
    // Update amounts if they exist
    const approvedAmountSpan = document.querySelector('.card:nth-child(2) .card-body .text-muted');
    const pendingAmountSpan = document.querySelector('.card:nth-child(3) .card-body .text-muted');
    const rejectedAmountSpan = document.querySelector('.card:nth-child(4) .card-body .text-muted');
    
    if (approvedAmountSpan) approvedAmountSpan.textContent = `Total amount: ₹${approvedAmount.toFixed(2)}`;
    if (pendingAmountSpan) pendingAmountSpan.textContent = `Awaiting approval: ₹${pendingAmount.toFixed(2)}`;
    if (rejectedAmountSpan) rejectedAmountSpan.textContent = `Total amount: ₹${rejectedAmount.toFixed(2)}`;
}

// Auto-refresh expenses every 5 seconds for real-time status updates
setInterval(() => {
    console.log('Auto-refreshing expenses for status updates...');
    loadExpenses().catch(error => {
        console.error('Auto-refresh error:', error);
    });
}, 5000);
</script>


<!-- Professional Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title d-flex align-items-center" id="confirmationModalLabel">
                    <div class="confirmation-icon me-3">
                        <i class="fas fa-question-circle"></i>
                    </div>
                    <span id="confirmationTitle">Confirm Action</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body pt-0">
                <p class="mb-3" id="confirmationMessage">Are you sure you want to proceed with this action?</p>
                <div class="confirmation-details" id="confirmationDetails" style="display: none;">
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>Important Notice</h6>
                        <div id="confirmationRequestInfo"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="confirmationConfirmBtn">
                    <i class="fas fa-check me-2"></i>Confirm
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
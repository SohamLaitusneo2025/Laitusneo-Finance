{% extends "sub_user_base.html" %}

{% block title %}Sub User Transactions{% endblock %}

{% block content %}
<style>
/* Compact Table Styling - Same look, less spacing */
#transactionsTable th,
#transactionsTable td {
    padding: 6px 8px;
    font-size: 0.9rem;
}

#transactionsTable thead th {
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
    font-weight: 600;
}

#transactionsTable tbody tr:hover {
    background-color: #f8f9fa;
}
</style>

<div class="professional-dashboard">
    <!-- Header Section -->
    <div class="header-section">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center">
                <div class="page-header">
                    <!-- Removed title and subtitle -->
                </div>
                <div class="action-buttons">
                    <button class="btn btn-outline-success btn-sm" id="bulkExportTransactions" style="display: none;" onclick="bulkExportTransactions()">
                        <i class="fas fa-file-pdf me-1"></i>Export Selected (<span id="selectedTransactionsCount">0</span>)
                    </button>
                    <button class="btn btn-outline-danger btn-sm" id="bulkDeleteTransactions" style="display: none;" onclick="bulkDeleteTransactions()">
                        <i class="fas fa-trash me-1"></i>Delete Selected (<span id="selectedTransactionsDeleteCount">0</span>)
                    </button>
                    <button class="btn btn-outline-secondary search-toggle-btn me-2" id="searchToggleBtn" onclick="toggleSearch()">
                        <i class="fas fa-search"></i>
                    </button>
                    <button class="btn btn-primary add-btn" data-bs-toggle="modal" data-bs-target="#transactionModal">
                        <i class="fas fa-plus me-2"></i>Add Transaction Request
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="filters-section" id="filtersSection" style="display: none;">
        <div class="container-fluid">
            <div class="filter-card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="fas fa-filter me-2"></i>Filter Options
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-2">
                            <label for="filterUniqueId" class="form-label">Unique ID</label>
                            <input type="text" class="form-control" id="filterUniqueId" placeholder="Search by ID..." onkeyup="filterTransactions()">
                        </div>
                        <div class="col-md-2">
                            <label for="filterType" class="form-label">Type</label>
                            <select class="form-select" id="filterType" onchange="filterTransactions()">
                                <option value="">All Types</option>
                                <option value="income">Income</option>
                                <option value="expense">Expense</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="filterCategory" class="form-label">Category</label>
                            <input type="text" class="form-control" id="filterCategory" placeholder="Category..." onkeyup="filterTransactions()">
                        </div>
                        <div class="col-md-2">
                            <label for="filterPaymentMethod" class="form-label">Payment Method</label>
                            <select class="form-select" id="filterPaymentMethod" onchange="filterTransactions()">
                                <option value="">All Methods</option>
                                <option value="cash">Cash</option>
                                <option value="online">Online</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="filterDateFrom" class="form-label">From Date</label>
                            <input type="date" class="form-control" id="filterDateFrom" onchange="filterTransactions()">
                        </div>
                        <div class="col-md-2">
                            <label for="filterDateTo" class="form-label">To Date</label>
                            <input type="date" class="form-control" id="filterDateTo" onchange="filterTransactions()">
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-2">
                            <button class="btn btn-outline-secondary w-100" onclick="clearTransactionFilters()">
                                <i class="fas fa-times me-1"></i>Clear Filters
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transactions Table Section -->
    <div class="table-section">
        <div class="container-fluid">
            <div class="table-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title">
                        <i class="fas fa-list me-2"></i>Transaction Requests
                        <span class="badge bg-primary ms-2" id="transactionCount">0</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table class="detail-table" id="transactionsTable">
                            <thead>
                                <tr>
                                    <th>
                                        <input type="checkbox" id="selectAllTransactions" class="form-check-input" title="Select All">
                                    </th>
                                    <th>Unique ID</th>
                                    <th>Title</th>
                                    <th>Amount</th>
                                    <th>Type</th>
                                    <th>Category</th>
                                    <th>Payment Method</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="empty-state" id="noTransactions" style="display: none;">
                        <div class="empty-icon">
                            <i class="fas fa-exchange-alt"></i>
                        </div>
                        <h4>No Transaction Requests Found</h4>
                        <p>Start by submitting your first transaction request.</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#transactionModal">
                            <i class="fas fa-plus me-2"></i>Add First Request
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Transaction Modal -->
<div class="modal fade" id="transactionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content professional-modal">
                <div class="modal-header">
                <h5 class="modal-title" id="transactionModalTitle">
                    <i class="fas fa-plus me-2"></i>Add Transaction Request
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                    <div class="modal-body">
                <form id="transactionForm" enctype="multipart/form-data">
                    <input type="hidden" id="transactionId" name="transaction_id">
                    <div class="row g-3">
                            <div class="col-md-6">
                            <label for="transactionTitle" class="form-label">Transaction Title *</label>
                                    <input type="text" class="form-control" id="transactionTitle" name="title" required>
                            </div>
                            <div class="col-md-6">
                            <label for="transactionAmount" class="form-label">Amount *</label>
                            <div class="input-group">
                                <span class="input-group-text">₹</span>
                                    <input type="number" class="form-control" id="transactionAmount" name="amount" step="0.01" min="0" required>
                            </div>
                        </div>
                            <div class="col-md-6">
                            <label for="transactionType" class="form-label">Transaction Type *</label>
                                    <select class="form-select" id="transactionType" name="transaction_type" required>
                                        <option value="">Select Type</option>
                                <option value="income">Income</option>
                                <option value="expense">Expense</option>
                                    </select>
                        </div>
                        <div class="col-md-6">
                            <label for="transactionPaymentMethod" class="form-label">Payment Method *</label>
                            <select class="form-select" id="transactionPaymentMethod" name="payment_method" required onchange="toggleTransactionBankSelection()">
                                <option value="cash">Cash</option>
                                <option value="online">Online</option>
                            </select>
                        </div>
                        <div class="col-md-6" id="transactionBankSelectionDiv" style="display: none;">
                            <label for="transactionBankAccount" class="form-label">Bank Account *</label>
                            <select class="form-select" id="transactionBankAccount" name="bank_account_id">
                                <option value="">Choose a bank account...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="transactionCategory" class="form-label">Category</label>
                            <input type="text" class="form-control" id="transactionCategory" name="category" list="transactionCategoryOptions">
                            <datalist id="transactionCategoryOptions">
                                <option value="Business Income">
                                <option value="Personal Income">
                                <option value="Office Supplies">
                                <option value="Travel">
                                <option value="Meals">
                                <option value="Marketing">
                                <option value="Utilities">
                                <option value="Other">
                            </datalist>
                        </div>
                        <div class="col-md-6">
                            <label for="transactionDate" class="form-label">Date *</label>
                            <input type="date" class="form-control" id="transactionDate" name="transaction_date" required>
                        </div>
                        <div class="col-12">
                            <label for="transactionDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="transactionDescription" name="description" rows="3" placeholder="Additional details about the transaction..."></textarea>
                    </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveTransaction()">
                    <i class="fas fa-save me-2"></i>Save Request
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    <script>
console.log('=== TRANSACTIONS SCRIPT BLOCK LOADED ===');

// Global variables
let editingTransactionId = null;

// Toggle bank selection for transactions
function toggleTransactionBankSelection() {
    const paymentMethod = document.getElementById('transactionPaymentMethod').value;
    const bankDiv = document.getElementById('transactionBankSelectionDiv');
    const bankSelect = document.getElementById('transactionBankAccount');
    
    if (paymentMethod === 'online') {
        bankDiv.style.display = 'block';
        loadTransactionBankAccounts();
    } else {
        bankDiv.style.display = 'none';
        bankSelect.innerHTML = '<option value="">Choose a bank account...</option>';
    }
}

// Load bank accounts for transactions
function loadTransactionBankAccounts() {
    const bankSelect = document.getElementById('transactionBankAccount');
    
    fetch('/api/sub-user/banks')
                .then(response => response.json())
                .then(data => {
        bankSelect.innerHTML = '<option value="">Choose a bank account...</option>';
        
        if (data && data.length > 0) {
            data.forEach(account => {
                const option = document.createElement('option');
                option.value = account.id;
                option.textContent = `${account.bank_name} - ${account.account_number}`;
                bankSelect.appendChild(option);
            });
        } else {
            bankSelect.innerHTML = '<option value="">No bank accounts available</option>';
        }
                })
                .catch(error => {
        console.error('Error loading bank accounts:', error);
        bankSelect.innerHTML = '<option value="">Error loading bank accounts</option>';
    });
}

// Save transaction function
async function saveTransaction() {
    try {
        const form = document.getElementById('transactionForm');
        const formData = new FormData(form);
        
        // Client-side validation
        const title = document.getElementById('transactionTitle').value.trim();
        const amount = document.getElementById('transactionAmount').value;
        const transactionType = document.getElementById('transactionType').value;
        const paymentMethod = document.getElementById('transactionPaymentMethod').value;
        const bankAccount = document.getElementById('transactionBankAccount').value;
        
        if (!title) {
            alert('Please enter the transaction title');
                return;
            }
            
        if (!amount || parseFloat(amount) <= 0) {
            alert('Please enter a valid amount');
            return;
        }
        
        if (!transactionType) {
            alert('Please select a transaction type');
            return;
        }
        
        if (paymentMethod === 'online' && !bankAccount) {
            alert('Please select a bank account for online payments');
            return;
        }
        
        const isEdit = editingTransactionId !== null;
        const url = isEdit ? `/api/sub-user/transaction-requests/${editingTransactionId}` : '/api/sub-user/transaction-requests';
        const method = isEdit ? 'PUT' : 'POST';
        
        // Convert FormData to JSON for sub-user API
        const requestData = {
            title: formData.get('title'),
            amount: parseFloat(formData.get('amount')),
            transaction_type: formData.get('transaction_type'),
            payment_method: formData.get('payment_method'),
            bank_account_id: formData.get('bank_account_id') || null,
            category: formData.get('category') || '',
            transaction_date: formData.get('transaction_date'),
            description: formData.get('description') || ''
        };
        
        const response = await fetch(url, {
            method: method,
            body: JSON.stringify(requestData),
            headers: { 'Content-Type': 'application/json' }
        });
        
        if (response.ok) {
            const result = await response.json();
            triggerNotification(result.message || (isEdit ? 'Transaction updated successfully' : 'Transaction request submitted successfully'), 'success');
            
            // Close modal and reset form
            const modal = bootstrap.Modal.getInstance(document.getElementById('transactionModal'));
            modal.hide();
            resetTransactionForm();
            
            // Reload transactions
            loadTransactions();
        } else {
            const error = await response.json();
            triggerNotification(error.error || 'An error occurred while saving the transaction', 'error');
        }
    } catch (error) {
        console.error('Error saving transaction:', error);
        triggerNotification('An unexpected error occurred. Please try again.', 'error');
    }
}

// Load transactions and approved expenses
async function loadTransactions() {
    try {
        console.log('Loading transactions and approved expenses...');
        
        // Load both transaction requests and approved expenses
        const [transactionsResponse, expensesResponse] = await Promise.all([
            fetch('/api/sub-user/transaction-requests'),
            fetch('/api/sub-user/approved-expenses')
        ]);
        
        let allTransactions = [];
        
        // Process transaction requests
        if (transactionsResponse.ok) {
            const transactionsData = await transactionsResponse.json();
            const transactionRequests = transactionsData.requests || [];
            allTransactions = allTransactions.concat(transactionRequests.map(t => ({
                ...t,
                source_type: 'transaction_request'
            })));
        }
        
        // Process approved expenses
        if (expensesResponse.ok) {
            const expensesData = await expensesResponse.json();
            const approvedExpenses = expensesData.expenses || [];
            allTransactions = allTransactions.concat(approvedExpenses.map(e => ({
                ...e,
                source_type: 'approved_expense',
                transaction_type: 'debit', // Expenses are debit transactions
                title: e.title || e.purpose,
                category: e.category || '',
                payment_method: e.payment_method || 'cash',
                transaction_date: e.expense_date || e.created_at,
                status: 'approved' // Approved expenses are always approved
            })));
        }
        
        // Sort by date (newest first)
        allTransactions.sort((a, b) => {
            const dateA = new Date(a.transaction_date || a.created_at);
            const dateB = new Date(b.transaction_date || b.created_at);
            return dateB - dateA;
        });
        
        console.log('Combined transactions and expenses:', allTransactions);
        displayTransactions(allTransactions);
        
    } catch (error) {
        console.error('Error loading transactions:', error);
        const tbody = document.querySelector('#transactionsTable tbody');
        tbody.innerHTML = '<tr><td colspan="10" class="text-center">Error loading transactions: ' + error.message + '</td></tr>';
    }
}

// Display transactions in table
function displayTransactions(transactions) {
    const tbody = document.querySelector('#transactionsTable tbody');
    const countBadge = document.getElementById('transactionCount');
    
    if (countBadge) {
        countBadge.textContent = transactions.length;
    }
    
    if (transactions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="text-center">No transactions or approved expenses found</td></tr>';
        return;
    }
    
    tbody.innerHTML = transactions.map(transaction => {
        // Handle potential null or undefined values
        const title = transaction.title || '-';
        const amount = parseFloat(transaction.amount) || 0;
        const backendTransactionType = transaction.transaction_type || 'debit';
        // Map backend types to frontend display types
        const transactionTypeMapping = {
            'credit': 'income',
            'debit': 'expense'
        };
        const transactionType = transactionTypeMapping[backendTransactionType] || 'expense';
        const category = transaction.category || '-';
        const paymentMethod = transaction.payment_method || 'cash';
        const transactionDate = transaction.transaction_date || transaction.created_at || null;
        const status = transaction.status || 'unknown';
        const sourceType = transaction.source_type || 'transaction_request';
        
        // Format date properly
        let dateStr = '-';
        if (transactionDate) {
            try {
                const date = new Date(transactionDate);
                if (!isNaN(date.getTime())) {
                    dateStr = date.toLocaleDateString();
                }
            } catch (e) {
                console.error('Error formatting date:', e);
                dateStr = '-';
            }
        }
        
        // Determine status badge
        let statusBadge = '';
        switch (status.toLowerCase()) {
            case 'pending':
                statusBadge = '<span class="badge bg-warning">PENDING APPROVAL</span>';
                break;
            case 'approved':
                statusBadge = '<span class="badge bg-success">APPROVED</span>';
                break;
            case 'rejected':
                statusBadge = '<span class="badge bg-danger">REJECTED</span>';
                break;
            default:
                statusBadge = '<span class="badge bg-secondary">UNKNOWN</span>';
        }
        
        // Handle unique ID
        const uniqueId = transaction.unique_id || '-';
        const uniqueIdDisplay = uniqueId !== '-' ? 
            `<code class="text-primary">${uniqueId}</code>` : 
            '<span class="text-muted">-</span>';

        // Add source type indicator
        const sourceIndicator = sourceType === 'approved_expense' ? 
            '<span class="badge bg-info me-1" title="Approved Expense">EXP</span>' : 
            '<span class="badge bg-secondary me-1" title="Transaction Request">TXN</span>';

        return `
            <tr>
                <td>
                    <input type="checkbox" class="form-check-input transaction-checkbox" value="${transaction.id}" onchange="updateBulkButtons()">
                </td>
                <td>${uniqueIdDisplay}</td>
                <td>${sourceIndicator}${title}</td>
                <td class="${transactionType === 'income' ? 'text-success' : 'text-danger'}">
                    ${transactionType === 'income' ? '+' : '-'}₹${amount.toFixed(2)}
                </td>
                <td><span class="badge bg-${transactionType === 'income' ? 'success' : 'danger'}">${transactionType}</span></td>
                <td>${category}</td>
                <td><span class="badge bg-${paymentMethod === 'online' ? 'success' : 'secondary'}">${paymentMethod}</span></td>
                <td>${dateStr}</td>
                <td>${statusBadge}</td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        ${sourceType === 'transaction_request' ? 
                            `<button class="btn btn-outline-danger" onclick="deleteTransaction(${transaction.id})" title="Delete Transaction">
                                <i class="fas fa-trash"></i>
                            </button>` : 
                            `<button class="btn btn-outline-secondary" disabled title="Cannot delete approved expenses">
                                <i class="fas fa-lock"></i>
                            </button>`
                        }
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}


// Delete individual transaction
async function deleteTransaction(transactionId) {
    try {
        const confirmed = confirm(
            'Are you sure you want to delete this transaction? This action cannot be undone.'
        );
        
        if (!confirmed) {
            return;
        }
        
        console.log('Deleting transaction:', transactionId);
        
        const response = await fetch(`/api/sub-user/transaction-requests/${transactionId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            showAlert(result.message, 'success');
            console.log('Delete result:', result);
            
            // Reload transactions
            loadTransactions();
        } else {
            throw new Error(result.message || 'Failed to delete transaction');
        }
        
    } catch (error) {
        console.error('Error deleting transaction:', error);
        showAlert('Error deleting transaction: ' + error.message, 'danger');
    }
}

// Update bulk action buttons based on selected checkboxes
function updateBulkButtons() {
    const checkboxes = document.querySelectorAll('.transaction-checkbox:checked');
    const bulkDeleteBtn = document.getElementById('bulkDeleteTransactions');
    const bulkExportBtn = document.getElementById('bulkExportTransactions');
    
    if (!bulkDeleteBtn || !bulkExportBtn) {
        console.error('Bulk action buttons not found');
        return;
    }
    
    const selectedCount = checkboxes.length;
    const selectedDeleteCount = document.getElementById('selectedTransactionsDeleteCount');
    const selectedExportCount = document.getElementById('selectedTransactionsCount');
    
    const showButtons = selectedCount > 0;
    
    bulkDeleteBtn.style.display = showButtons ? 'inline-block' : 'none';
    bulkExportBtn.style.display = showButtons ? 'inline-block' : 'none';
    
    if (selectedDeleteCount) selectedDeleteCount.textContent = selectedCount;
    if (selectedExportCount) selectedExportCount.textContent = selectedCount;
}

// Initialize select all functionality
function initializeSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAllTransactions');
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.transaction-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateBulkButtons();
        });
    }
}

// Bulk export selected transactions
async function bulkExportTransactions() {
    try {
        const selectedCheckboxes = document.querySelectorAll('.transaction-checkbox:checked');
        const selectedIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));
        
        if (selectedIds.length === 0) {
            showAlert('No transactions selected for export.', 'warning');
            return;
        }
        
        console.log('Exporting transactions:', selectedIds);
        
        const exportBtn = document.getElementById('bulkExportTransactions');
        const originalText = exportBtn.innerHTML;
        exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Exporting...';
        exportBtn.disabled = true;
        
        // Create a hidden form to submit the selected IDs
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/api/sub-user/transactions/export';
        form.style.display = 'none';
        
        selectedIds.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'transaction_ids';
            input.value = id;
            form.appendChild(input);
        });
        
        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);
        
        showAlert(`Exporting ${selectedIds.length} selected transaction(s) to PDF...`, 'success');
        
        // Reset button
        setTimeout(() => {
            exportBtn.innerHTML = originalText;
            exportBtn.disabled = false;
        }, 2000);
        
    } catch (error) {
        console.error('Error exporting transactions:', error);
        showAlert('Error exporting transactions: ' + error.message, 'danger');
        
        const exportBtn = document.getElementById('bulkExportTransactions');
        exportBtn.innerHTML = '<i class="fas fa-file-pdf me-1"></i>Export Selected (<span id="selectedTransactionsCount">0</span>)';
        exportBtn.disabled = false;
    }
}

// Bulk delete selected transactions
async function bulkDeleteTransactions() {
    try {
        const selectedCheckboxes = document.querySelectorAll('.transaction-checkbox:checked');
        const selectedIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));
        
        if (selectedIds.length === 0) {
            showAlert('No transactions selected for deletion.', 'warning');
            return;
        }
        
        const confirmed = confirm(
            `Are you sure you want to delete ${selectedIds.length} selected transaction(s)? This action cannot be undone.`
        );
        
        if (!confirmed) {
            return;
        }
        
        console.log('Bulk deleting transactions:', selectedIds);
        
        const deleteBtn = document.getElementById('bulkDeleteTransactions');
        const originalText = deleteBtn.innerHTML;
        deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Deleting...';
        deleteBtn.disabled = true;
        
        // Use the bulk delete endpoint
        const response = await fetch('/api/sub-user/transaction-requests/bulk-delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                transaction_ids: selectedIds
            })
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            showAlert(result.message, 'success');
            console.log('Bulk delete result:', result);
        } else {
            throw new Error(result.message || 'Failed to delete transactions');
        }
        
        // Reset select all checkbox
        document.getElementById('selectAllTransactions').checked = false;
        
        // Reload transactions
        loadTransactions();
        
        // Reset button
        deleteBtn.innerHTML = originalText;
        deleteBtn.disabled = false;
        
    } catch (error) {
        console.error('Error in bulk delete:', error);
        showAlert('Error deleting transactions: ' + error.message, 'danger');
        
        const deleteBtn = document.getElementById('bulkDeleteTransactions');
        deleteBtn.innerHTML = '<i class="fas fa-trash me-1"></i>Delete Selected (<span id="selectedTransactionsDeleteCount">0</span>)';
        deleteBtn.disabled = false;
    }
}

// Reset transaction form
function resetTransactionForm() {
    document.getElementById('transactionForm').reset();
    document.getElementById('transactionDate').valueAsDate = new Date();
    document.getElementById('transactionPaymentMethod').value = 'cash';
    document.getElementById('transactionBankSelectionDiv').style.display = 'none';
    document.getElementById('transactionBankAccount').value = '';
    editingTransactionId = null;
}

// Show alert notification
function showAlert(message, type = 'info') {
    // Create alert element
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.style.position = 'fixed';
    alertDiv.style.top = '20px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '9999';
    alertDiv.style.minWidth = '300px';
    
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Add to page
    document.body.appendChild(alertDiv);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 5000);
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== TRANSACTIONS PAGE INITIALIZATION START ===');
    console.log('Transactions page loaded, initializing...');
    
    try {
        // Set default date to today
        const today = new Date();
        const formattedDate = today.toISOString().split('T')[0];
        document.getElementById('transactionDate').value = formattedDate;
        
        document.getElementById('transactionPaymentMethod').value = 'cash';
        document.getElementById('transactionBankSelectionDiv').style.display = 'none';
        document.getElementById('transactionBankAccount').value = '';
        
        console.log('Form initialized, loading transactions...');
        
        // Initialize select all functionality
        initializeSelectAll();
        
        // Load initial data
        loadTransactions().catch(error => {
            console.error('Error loading transactions on page load:', error);
            const tbody = document.querySelector('#transactionsTable tbody');
            tbody.innerHTML = '<tr><td colspan="10" class="text-center">Error loading transactions. Please try refreshing the page.</td></tr>';
        });
        
        console.log('=== TRANSACTIONS PAGE INITIALIZATION COMPLETE ===');
    } catch (error) {
        console.error('Error during page initialization:', error);
        alert('Error during page initialization: ' + error.message);
    }
});
    </script>
{% endblock %}
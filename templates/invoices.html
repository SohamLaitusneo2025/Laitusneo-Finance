{% extends "base.html" %}

{% block title %}Invoices{% endblock %}

{% block content %}
<style>
/* Compact Table Styling - Same look, less spacing */
#invoicesTable th,
#invoicesTable td {
    padding: 6px 8px;
    font-size: 0.9rem;
}

#invoicesTable thead th {
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
    font-weight: 600;
}

#invoicesTable tbody tr:hover {
    background-color: #f8f9fa;
}

/* Compact Invoice Form Styling */
#invoiceModal .form-label {
    font-size: 0.9rem;
    margin-bottom: 0.25rem;
    font-weight: 500;
}

#invoiceModal .form-control,
#invoiceModal .form-select {
    padding: 0.375rem 0.5rem;
    font-size: 0.9rem;
}

#invoiceModal .modal-body {
    padding: 1rem;
}

#invoiceModal .modal-header {
    padding: 0.75rem 1rem;
}

#invoiceModal .modal-footer {
    padding: 0.75rem 1rem;
}

#invoiceModal h6 {
    font-size: 0.95rem;
    margin-bottom: 0.5rem;
}

/* Company fields visibility */
#companySection.hidden {
    display: none !important;
}

.company-field-hidden {
    display: none !important;
}
</style>

<div class="professional-dashboard">
    <!-- Header Section -->
    <div class="header-section">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center">
                <div class="page-header">
                    <!-- Removed title and subtitle -->
                </div>
                <div class="action-buttons">
                    <button class="btn btn-outline-secondary search-toggle-btn me-2" id="searchToggleBtn" onclick="toggleSearch()">
                        <i class="fas fa-search"></i>
                    </button>
                    <div class="btn-group" role="group">
                        <button class="btn btn-primary add-btn me-2" onclick="openInvoiceModal('out')">
                            <i class="fas fa-plus me-2"></i>Create Out Invoice
                        </button>
                        <button class="btn btn-success add-btn" onclick="openInvoiceModal('in')">
                            <i class="fas fa-plus me-2"></i>Create In Invoice
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Cards Section -->
    <div class="metrics-section">
        <div class="container-fluid">
            <div class="row g-4">
                <div class="col-lg-3 col-md-6">
                    <div class="metric-card primary">
                        <div class="metric-icon">
                            <i class="fas fa-file-invoice"></i>
                        </div>
                        <div class="metric-content">
                            <h3 class="metric-value" id="totalInvoices">0</h3>
                            <p class="metric-label">Total Invoices</p>
                            <small class="metric-description">In: <span id="totalInAmount">₹0.00</span> | Out: <span id="totalOutAmount">₹0.00</span></small>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="metric-card success">
                        <div class="metric-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="metric-content">
                            <h3 class="metric-value" id="paidInvoiceCount">0</h3>
                            <p class="metric-label">Paid Invoices</p>
                            <small class="metric-description">Total amount: <span id="paidAmount">₹0.00</span></small>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="metric-card warning">
                        <div class="metric-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="metric-content">
                            <h3 class="metric-value" id="pendingInvoiceCount">0</h3>
                            <p class="metric-label">Pending Invoices</p>
                            <small class="metric-description">Total amount: <span id="pendingAmount">₹0.00</span></small>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="metric-card info">
                        <div class="metric-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="metric-content">
                            <h3 class="metric-value" id="overdueInvoiceCount">0</h3>
                            <p class="metric-label">Overdue Invoices</p>
                            <small class="metric-description">Total amount: <span id="overdueAmount">₹0.00</span></small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter Section -->
    <div class="filters-section" id="filtersSection" style="display: none;">
        <div class="container-fluid">
            <div class="filter-card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="fas fa-search me-2"></i>Search & Filter
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="invoiceSearch" class="form-label">Search Invoices</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control" id="invoiceSearch" placeholder="Search by invoice number or client name..." onkeyup="searchInvoices()">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <label for="filterInvoiceUniqueId" class="form-label">Unique ID</label>
                            <input type="text" class="form-control" id="filterInvoiceUniqueId" placeholder="Search by ID..." onkeyup="searchInvoices()">
                        </div>
                        <div class="col-md-2">
                            <label for="filterInvoiceStatus" class="form-label">Status</label>
                            <select class="form-select" id="filterInvoiceStatus" onchange="filterInvoices()">
                                <option value="">All Status</option>
                                <option value="draft">Draft</option>
                                <option value="sent">Sent</option>
                                <option value="paid">Paid</option>
                                <option value="overdue">Overdue</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="filterInvoiceType" class="form-label">Type</label>
                            <select class="form-select" id="filterInvoiceType" onchange="filterInvoices()">
                                <option value="">All Types</option>
                                <option value="in">In Invoice</option>
                                <option value="out">Out Invoice</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="filterInvoiceDateFrom" class="form-label">From Date</label>
                            <input type="date" class="form-control" id="filterInvoiceDateFrom" onchange="filterInvoices()">
                        </div>
                        <div class="col-md-2">
                            <label for="filterInvoiceDateTo" class="form-label">To Date</label>
                            <input type="date" class="form-control" id="filterInvoiceDateTo" onchange="filterInvoices()">
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-2">
                            <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                                <i class="fas fa-times me-1"></i>Clear
                            </button>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-warning w-100" onclick="testInvoiceAPI()" title="Debug: Force Load Invoices">
                                <i class="fas fa-bug me-1"></i>Debug
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoices Table Section -->
    <div class="table-section">
        <div class="container-fluid">
            <div class="table-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title">
                        <i class="fas fa-list me-2"></i>All Invoices
                        <span class="badge bg-primary ms-2" id="invoiceCount">0</span>
                    </h5>
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-success btn-sm" id="bulkExportInvoices" style="display: none;" onclick="bulkExportInvoices()">
                            <i class="fas fa-file-pdf me-1"></i>Export Selected (<span id="selectedInvoicesCount">0</span>)
                        </button>
                        <button class="btn btn-outline-danger btn-sm" id="bulkDeleteInvoices" style="display: none;" onclick="bulkDeleteInvoices()">
                            <i class="fas fa-trash me-1"></i>Delete Selected (<span id="selectedInvoicesDeleteCount">0</span>)
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table class="detail-table" id="invoicesTable">
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" id="selectAllInvoices" class="form-check-input" title="Select All">
                        </th>
                        <th>Unique ID</th>
                        <th>Invoice #</th>
                        <th>Client</th>
                        <th>Type</th>
                        <th>Date</th>
                        <th>Due Date</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="invoicesTableBody">
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            <i class="fas fa-spinner fa-spin me-2"></i>Loading invoices...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Create Invoice Modal -->
<div class="modal fade" id="invoiceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Create Invoice
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="invoiceForm">
                    <input type="hidden" id="invoiceId" name="invoice_id">
                    <input type="hidden" id="invoiceType" name="invoice_type" value="out">
                    <div class="row g-2">
                        <!-- Invoice Type Selection -->
                        <div class="col-12">
                            <h6 class="border-bottom pb-1 mb-2"><i class="fas fa-cog me-2"></i>Invoice Configuration</h6>
                        </div>
                        <div class="col-md-6">
                            <label for="invoiceCategory" class="form-label">Invoice Category *</label>
                            <select class="form-select" id="invoiceCategory" name="invoice_category" required onchange="toggleCompanyFields()">
                                <option value="">Select Category</option>
                                <option value="individual">Individual</option>
                                <option value="business">Business</option>
                            </select>
                        </div>
                        
                        <!-- Company Information -->
                        <div class="col-12" id="companySection">
                            <h6 class="border-bottom pb-1 mb-2"><i class="fas fa-building me-2"></i>Company Information</h6>
                        </div>
                        <div class="col-md-6" id="companyNameField">
                            <label for="companyName" class="form-label">Company Name *</label>
                            <input type="text" class="form-control" id="companyName" name="company_name">
                        </div>
                        <div class="col-md-6" id="companyEmailField">
                            <label for="companyEmail" class="form-label">Company Email</label>
                            <input type="email" class="form-control" id="companyEmail" name="company_email">
                        </div>
                        <div class="col-md-6" id="companyPhoneField">
                            <label for="companyPhone" class="form-label">Company Phone</label>
                            <input type="tel" class="form-control" id="companyPhone" name="company_phone">
                        </div>
                        <div class="col-md-6" id="companyAddressField">
                            <label for="companyAddress" class="form-label">Company Address</label>
                            <textarea class="form-control" id="companyAddress" name="company_address" rows="1"></textarea>
                        </div>
                        
                        <!-- Invoice Details -->
                        <div class="col-12">
                            <h6 class="border-bottom pb-1 mb-2"><i class="fas fa-file-invoice me-2"></i>Invoice Details</h6>
                        </div>
                        <div class="col-md-6">
                            <label for="invoiceNumber" class="form-label">Invoice Number</label>
                            <input type="text" class="form-control" id="invoiceNumber" name="invoice_number" readonly>
                        </div>
                        <div class="col-md-6">
                            <label for="invoiceDate" class="form-label">Invoice Date *</label>
                            <input type="date" class="form-control" id="invoiceDate" name="invoice_date" required>
                        </div>
                        <div class="col-md-6">
                            <label for="dueDate" class="form-label">Due Date</label>
                            <input type="date" class="form-control" id="dueDate" name="due_date">
                        </div>
                        <div class="col-md-6">
                            <label for="status" class="form-label">Status</label>
                            <select class="form-select" id="status" name="status">
                                <option value="draft">Draft</option>
                                <option value="sent">Sent</option>
                                <option value="paid">Paid</option>
                                <option value="overdue">Overdue</option>
                            </select>
                        </div>
                        
                        <!-- Client Information -->
                        <div class="col-12">
                            <h6 class="border-bottom pb-1 mb-2"><i class="fas fa-user me-2"></i>Client Information</h6>
                        </div>
                        <div class="col-md-6">
                            <label for="clientName" class="form-label">Client Name *</label>
                            <input type="text" class="form-control" id="clientName" name="client_name" required>
                        </div>
                        <div class="col-md-6">
                            <label for="clientEmail" class="form-label">Client Email</label>
                            <input type="email" class="form-control" id="clientEmail" name="client_email">
                        </div>
                        <div class="col-md-6">
                            <label for="clientPhone" class="form-label">Client Phone</label>
                            <input type="tel" class="form-control" id="clientPhone" name="client_phone">
                        </div>
                        <div class="col-md-6">
                            <label for="clientAddress" class="form-label">Client Address</label>
                            <textarea class="form-control" id="clientAddress" name="client_address" rows="1"></textarea>
                        </div>
                        <div class="col-md-4">
                            <label for="clientState" class="form-label">Client State</label>
                            <select class="form-select" id="clientState" name="client_state">
                                <option value="">Select State</option>
                                <option value="Andhra Pradesh">Andhra Pradesh</option>
                                <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                                <option value="Assam">Assam</option>
                                <option value="Bihar">Bihar</option>
                                <option value="Chhattisgarh">Chhattisgarh</option>
                                <option value="Goa">Goa</option>
                                <option value="Gujarat">Gujarat</option>
                                <option value="Haryana">Haryana</option>
                                <option value="Himachal Pradesh">Himachal Pradesh</option>
                                <option value="Jharkhand">Jharkhand</option>
                                <option value="Karnataka">Karnataka</option>
                                <option value="Kerala">Kerala</option>
                                <option value="Madhya Pradesh">Madhya Pradesh</option>
                                <option value="Maharashtra">Maharashtra</option>
                                <option value="Manipur">Manipur</option>
                                <option value="Meghalaya">Meghalaya</option>
                                <option value="Mizoram">Mizoram</option>
                                <option value="Nagaland">Nagaland</option>
                                <option value="Odisha">Odisha</option>
                                <option value="Punjab">Punjab</option>
                                <option value="Rajasthan">Rajasthan</option>
                                <option value="Sikkim">Sikkim</option>
                                <option value="Tamil Nadu">Tamil Nadu</option>
                                <option value="Telangana">Telangana</option>
                                <option value="Tripura">Tripura</option>
                                <option value="Uttar Pradesh">Uttar Pradesh</option>
                                <option value="Uttarakhand">Uttarakhand</option>
                                <option value="West Bengal">West Bengal</option>
                                <option value="Andaman and Nicobar Islands">Andaman and Nicobar Islands</option>
                                <option value="Chandigarh">Chandigarh</option>
                                <option value="Dadra and Nagar Haveli and Daman and Diu">Dadra and Nagar Haveli and Daman and Diu</option>
                                <option value="Delhi">Delhi</option>
                                <option value="Jammu and Kashmir">Jammu and Kashmir</option>
                                <option value="Ladakh">Ladakh</option>
                                <option value="Lakshadweep">Lakshadweep</option>
                                <option value="Puducherry">Puducherry</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="clientPin" class="form-label">Client PIN</label>
                            <input type="text" class="form-control" id="clientPin" name="client_pin">
                        </div>
                        <div class="col-md-4">
                            <label for="clientGstin" class="form-label">Client GSTIN</label>
                            <input type="text" class="form-control" id="clientGstin" name="client_gstin">
                        </div>
                        <div class="col-md-6">
                            <label for="clientPan" class="form-label">Client PAN</label>
                            <input type="text" class="form-control" id="clientPan" name="client_pan">
                        </div>
                        
                        <!-- Billing Information -->
                        <div class="col-12">
                            <h6 class="border-bottom pb-1 mb-2"><i class="fas fa-map-marker-alt me-2"></i>Billing Information</h6>
                        </div>
                        <div class="col-md-6">
                            <label for="billingCompany" class="form-label">Billing Company</label>
                            <input type="text" class="form-control" id="billingCompany" name="billing_company_name">
                        </div>
                        <div class="col-md-6">
                            <label for="billingAddress" class="form-label">Billing Address</label>
                            <textarea class="form-control" id="billingAddress" name="billing_address" rows="1"></textarea>
                        </div>
                        <div class="col-md-4">
                            <label for="billingCity" class="form-label">Billing City</label>
                            <input type="text" class="form-control" id="billingCity" name="billing_city">
                        </div>
                        <div class="col-md-4">
                            <label for="billingState" class="form-label">Billing State *</label>
                            <select class="form-select" id="billingState" name="billing_state" required onchange="calculateGSTBasedOnState()">
                                <option value="">Select State</option>
                                <option value="Andhra Pradesh">Andhra Pradesh</option>
                                <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                                <option value="Assam">Assam</option>
                                <option value="Bihar">Bihar</option>
                                <option value="Chhattisgarh">Chhattisgarh</option>
                                <option value="Goa">Goa</option>
                                <option value="Gujarat">Gujarat</option>
                                <option value="Haryana">Haryana</option>
                                <option value="Himachal Pradesh">Himachal Pradesh</option>
                                <option value="Jharkhand">Jharkhand</option>
                                <option value="Karnataka">Karnataka</option>
                                <option value="Kerala">Kerala</option>
                                <option value="Madhya Pradesh">Madhya Pradesh</option>
                                <option value="Maharashtra">Maharashtra</option>
                                <option value="Manipur">Manipur</option>
                                <option value="Meghalaya">Meghalaya</option>
                                <option value="Mizoram">Mizoram</option>
                                <option value="Nagaland">Nagaland</option>
                                <option value="Odisha">Odisha</option>
                                <option value="Punjab">Punjab</option>
                                <option value="Rajasthan">Rajasthan</option>
                                <option value="Sikkim">Sikkim</option>
                                <option value="Tamil Nadu">Tamil Nadu</option>
                                <option value="Telangana">Telangana</option>
                                <option value="Tripura">Tripura</option>
                                <option value="Uttar Pradesh">Uttar Pradesh</option>
                                <option value="Uttarakhand">Uttarakhand</option>
                                <option value="West Bengal">West Bengal</option>
                                <option value="Andaman and Nicobar Islands">Andaman and Nicobar Islands</option>
                                <option value="Chandigarh">Chandigarh</option>
                                <option value="Dadra and Nagar Haveli and Daman and Diu">Dadra and Nagar Haveli and Daman and Diu</option>
                                <option value="Delhi">Delhi</option>
                                <option value="Jammu and Kashmir">Jammu and Kashmir</option>
                                <option value="Ladakh">Ladakh</option>
                                <option value="Lakshadweep">Lakshadweep</option>
                                <option value="Puducherry">Puducherry</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="billingPin" class="form-label">Billing PIN</label>
                            <input type="text" class="form-control" id="billingPin" name="billing_pin">
                        </div>
                        <div class="col-md-6">
                            <label for="gstinNumber" class="form-label">GSTIN Number</label>
                            <input type="text" class="form-control" id="gstinNumber" name="gstin_number">
                        </div>
                        <div class="col-md-6">
                            <label for="panNumber" class="form-label">PAN Number</label>
                            <input type="text" class="form-control" id="panNumber" name="pan_number">
                        </div>
                        
                        <!-- Invoice Items -->
                        <div class="col-12">
                            <h6 class="border-bottom pb-1 mb-2"><i class="fas fa-list me-2"></i>Invoice Items</h6>
                            <div id="itemsContainer">
                                <!-- Items will be added here -->
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addItem()">
                                <i class="fas fa-plus me-1"></i>Add Item
                            </button>
                        </div>
                        
                        <!-- Totals -->
                        <div class="col-12">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">Invoice Totals</h6>
                                    <table class="table table-borderless">
                                        <tr>
                                            <td><strong>Subtotal:</strong></td>
                                            <td class="text-end"><span id="subtotalDisplay">₹0.00</span></td>
                                        </tr>
                                        <tr>
                                            <td><strong>CGST:</strong></td>
                                            <td class="text-end"><span id="cgstDisplay">₹0.00</span></td>
                                        </tr>
                                        <tr>
                                            <td><strong>SGST:</strong></td>
                                            <td class="text-end"><span id="sgstDisplay">₹0.00</span></td>
                                        </tr>
                                        <tr>
                                            <td><strong>IGST:</strong></td>
                                            <td class="text-end"><span id="igstDisplay">₹0.00</span></td>
                                        </tr>
                                        <tr>
                                            <td><strong>Other Tax:</strong></td>
                                            <td class="text-end"><span id="taxDisplay">₹0.00</span></td>
                                        </tr>
                                        <tr class="table-primary">
                                            <td><strong>Total:</strong></td>
                                            <td class="text-end"><strong><span id="totalDisplay">₹0.00</span></strong></td>
                                        </tr>
                                    </table>
                                    <!-- Hidden fields for form submission -->
                                    <input type="hidden" id="subtotalInput" name="subtotal">
                                    <input type="hidden" id="cgstAmountInput" name="cgst_amount">
                                    <input type="hidden" id="sgstAmountInput" name="sgst_amount">
                                    <input type="hidden" id="igstAmountInput" name="igst_amount">
                                    <input type="hidden" id="taxInput" name="tax_amount">
                                    <input type="hidden" id="totalInput" name="total_amount">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Bank Details -->
                        <div class="col-12">
                            <h6 class="border-bottom pb-1 mb-2"><i class="fas fa-university me-2"></i>Bank Details</h6>
                        </div>
                        <div class="col-md-6">
                            <label for="selectedBank" class="form-label">Select Bank Account *</label>
                            <select class="form-select" id="selectedBank" name="selected_bank" required onchange="fillBankDetails()">
                                <option value="">Choose a bank account...</option>
                            </select>
                            <input type="hidden" id="bankAccountId" name="bank_account_id">
                        </div>
                        <div class="col-md-6">
                            <label for="bankName" class="form-label">Bank Name</label>
                            <input type="text" class="form-control" id="bankName" name="bank_name" readonly>
                        </div>
                        <div class="col-md-6">
                            <label for="accountNumber" class="form-label">Account Number</label>
                            <input type="text" class="form-control" id="accountNumber" name="account_number" readonly>
                        </div>
                        <div class="col-md-6">
                            <label for="ifscCode" class="form-label">IFSC Code</label>
                            <input type="text" class="form-control" id="ifscCode" name="ifsc_code" readonly>
                        </div>
                        <div class="col-md-6">
                            <label for="upiId" class="form-label">UPI ID</label>
                            <input type="text" class="form-control" id="upiId" name="upi_id" readonly>
                        </div>
                        
                        <!-- Additional Information -->
                        <div class="col-12">
                            <h6 class="border-bottom pb-1 mb-2"><i class="fas fa-sticky-note me-2"></i>Additional Information</h6>
                        </div>
                        <div class="col-12">
                            <label for="notes" class="form-label">Notes</label>
                            <textarea class="form-control" id="notes" name="notes" rows="2" placeholder="Any additional notes or comments"></textarea>
                        </div>
                        <div class="col-12">
                            <label for="termsConditions" class="form-label">Terms & Conditions</label>
                            <textarea class="form-control" id="termsConditions" name="terms_conditions" rows="2" placeholder="Terms and conditions"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveInvoice()">
                    <i class="fas fa-save me-1"></i>Save Invoice
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="deleteConfirmMessage">Are you sure you want to delete this item?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- View Invoice Modal -->
<div class="modal fade" id="viewInvoiceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-eye me-2"></i>Invoice Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="invoiceDetails">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<style>
.dropdown-menu.show {
    display: block;
    position: absolute;
    z-index: 1000;
}

.dropdown-menu {
    display: none;
}

.status-options-container {
    position: absolute;
    z-index: 1000;
    right: 10px;
    background: white;
    border: 1px solid rgba(0,0,0,0.15);
    border-radius: 0.25rem;
    padding: 0.5rem;
    box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
}

.status-options {
    display: flex;
    flex-direction: column;
    min-width: 180px;
}
</style>
<script>
// Global variables
let invoices = [];
let filteredInvoices = [];
let itemCounter = 0;

// Load invoices on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('Invoice page loaded');
    
    // Set default dates
    const today = new Date().toISOString().split('T')[0];
    const futureDate = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
    
    document.getElementById('invoiceDate').value = today;
    document.getElementById('dueDate').value = futureDate;
    
    // Add first item
    addItem();
    
    // Load invoices data
    loadInvoices();
    
    // Initialize any dropdowns that might be in the initial HTML
    initializeDropdowns();
});

// Add invoice item
function addItem() {
    const container = document.getElementById('itemsContainer');
    const itemIndex = container.children.length;
    
    const itemHTML = `
        <div class="invoice-item border rounded p-3 mb-3" data-item-index="${itemIndex}">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0">Item ${itemIndex + 1}</h6>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeItem(${itemIndex})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Description *</label>
                    <input type="text" class="form-control" name="items[${itemIndex}][description]" required>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Quantity *</label>
                    <input type="number" class="form-control" name="items[${itemIndex}][quantity]" min="0" step="1" value="1" required onchange="calculateItemTotal(this)">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Unit Price *</label>
                    <input type="number" class="form-control" name="items[${itemIndex}][unit_price]" min="0" step="0.01" required onchange="calculateItemTotal(this)">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Total</label>
                    <input type="number" class="form-control" name="items[${itemIndex}][total_price]" readonly>
                </div>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', itemHTML);
}

// Remove invoice item
function removeItem(index) {
    const item = document.querySelector(`[data-item-index="${index}"]`);
    if (item) {
        item.remove();
        calculateTotals();
    }
}

// Calculate item total
function calculateItemTotal(input) {
    const itemContainer = input.closest('.invoice-item');
    const quantityInput = itemContainer.querySelector('[name*="[quantity]"]');
    const priceInput = itemContainer.querySelector('[name*="[unit_price]"]');
    const totalInput = itemContainer.querySelector('[name*="[total_price]"]');
    
    const quantity = parseFloat(quantityInput.value) || 0;
    const price = parseFloat(priceInput.value) || 0;
    const total = quantity * price;
    
    totalInput.value = total.toFixed(2);
    calculateTotals();
}

// Calculate GST based on state
function calculateGSTBasedOnState() {
    console.log('State changed, recalculating GST...');
    calculateTotals();
}

// Calculate totals
function calculateTotals() {
    try {
        console.log('Calculating totals...');
        
        let subtotal = 0;
        
        // Calculate subtotal from items
        const itemTotals = document.querySelectorAll('[name*="[total_price]"]');
        itemTotals.forEach(input => {
            subtotal += parseFloat(input.value) || 0;
        });
        
        console.log('Subtotal calculated:', subtotal);
        
        // Get billing state for GST calculation
        const billingStateElement = document.getElementById('billingState');
        const billingState = billingStateElement ? billingStateElement.value : '';
        
        console.log('Billing state:', billingState);
        
        let cgstAmount = 0;
        let sgstAmount = 0;
        let igstAmount = 0;
        
        if (billingState === 'Uttar Pradesh') {
            // Same state - CGST and SGST
            cgstAmount = subtotal * 0.09; // 9%
            sgstAmount = subtotal * 0.09; // 9%
            igstAmount = 0;
            console.log('Uttar Pradesh selected - CGST/SGST applied');
        } else if (billingState && billingState !== '') {
            // Different state - IGST
            cgstAmount = 0;
            sgstAmount = 0;
            igstAmount = subtotal * 0.18; // 18%
            console.log('Other state selected - IGST applied');
        } else {
            // No state selected
            cgstAmount = 0;
            sgstAmount = 0;
            igstAmount = 0;
            console.log('No state selected');
        }
        
        const otherTax = 0; // You can add other tax calculation here
        const total = subtotal + cgstAmount + sgstAmount + igstAmount + otherTax;
        
        console.log('Tax amounts - CGST:', cgstAmount, 'SGST:', sgstAmount, 'IGST:', igstAmount, 'Total:', total);
        
        // Update display with error handling
        const elements = {
            'subtotalDisplay': `₹${subtotal.toFixed(2)}`,
            'cgstDisplay': `₹${cgstAmount.toFixed(2)}`,
            'sgstDisplay': `₹${sgstAmount.toFixed(2)}`,
            'igstDisplay': `₹${igstAmount.toFixed(2)}`,
            'taxDisplay': `₹${otherTax.toFixed(2)}`,
            'totalDisplay': `₹${total.toFixed(2)}`
        };
        
        Object.entries(elements).forEach(([id, value]) => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
            } else {
                console.error(`Element with id '${id}' not found`);
            }
        });
        
        // Update hidden fields with error handling
        const hiddenFields = {
            'subtotalInput': subtotal.toFixed(2),
            'cgstAmountInput': cgstAmount.toFixed(2),
            'sgstAmountInput': sgstAmount.toFixed(2),
            'igstAmountInput': igstAmount.toFixed(2),
            'taxInput': otherTax.toFixed(2),
            'totalInput': total.toFixed(2)
        };
        
        Object.entries(hiddenFields).forEach(([id, value]) => {
            const element = document.getElementById(id);
            if (element) {
                element.value = value;
            } else {
                console.error(`Hidden field with id '${id}' not found`);
            }
        });
        
        console.log('Totals calculation completed successfully');
        
    } catch (error) {
        console.error('Error in calculateTotals:', error);
    }
}

// NEW SIMPLIFIED saveInvoice function
async function editInvoice(id) {
    try {
        // Show loading indicator
        showNotification('Loading invoice data...', 'info');
        
        // Fetch invoice data
        const response = await fetch(`/api/invoices/${id}`);
        if (!response.ok) {
            throw new Error(`Failed to fetch invoice: ${response.statusText}`);
        }
        
        const invoice = await response.json();
        console.log('Fetched invoice data:', invoice);
        
        // Update modal title
        document.getElementById('invoiceModal').querySelector('.modal-title').innerHTML = `
            <i class="fas fa-edit me-2"></i>Edit Invoice ${invoice.invoice_number}
        `;
        
        // Update the save button text
        const saveButton = document.querySelector('#invoiceModal .modal-footer .btn-primary');
        if (saveButton) {
            saveButton.innerHTML = '<i class="fas fa-save me-1"></i>Update Invoice';
        }
        
        // Set invoice ID and type for tracking edit mode
        document.getElementById('invoiceId').value = invoice.id;
        document.getElementById('invoiceType').value = invoice.invoice_type || 'out';
        
        // Determine invoice category based on whether company details exist
        let invoiceCategory = 'business';
        if (invoice.invoice_type === 'in') {
            // For In invoices, check if vendor details exist
            if (!invoice.client_name || !invoice.client_email) {
                invoiceCategory = 'individual';
            }
        } else {
            // For Out invoices, check if company details exist
            if (!invoice.company_name || !invoice.company_email) {
                invoiceCategory = 'individual';
            }
        }
        
        // Set the category and toggle fields accordingly
        document.getElementById('invoiceCategory').value = invoiceCategory;
        toggleCompanyFields();
        
        // Fill the form fields based on invoice type
        if (invoice.invoice_type === 'in') {
            // For In invoices, swap company and client information
            document.getElementById('companyName').value = invoice.client_name || '';
            document.getElementById('companyEmail').value = invoice.client_email || '';
            document.getElementById('companyPhone').value = invoice.client_phone || '';
            document.getElementById('companyAddress').value = invoice.client_address || '';
            
            document.getElementById('clientName').value = invoice.company_name || '';
            document.getElementById('clientEmail').value = invoice.company_email || '';
            document.getElementById('clientPhone').value = invoice.company_phone || '';
            document.getElementById('clientAddress').value = invoice.company_address || '';
            
            // Update section titles
            swapCompanyClientSections(true);
        } else {
            // For Out invoices, use normal order
            document.getElementById('companyName').value = invoice.company_name || '';
            document.getElementById('companyEmail').value = invoice.company_email || '';
            document.getElementById('companyPhone').value = invoice.company_phone || '';
            document.getElementById('companyAddress').value = invoice.company_address || '';
            
            document.getElementById('clientName').value = invoice.client_name || '';
            document.getElementById('clientEmail').value = invoice.client_email || '';
            document.getElementById('clientPhone').value = invoice.client_phone || '';
            document.getElementById('clientAddress').value = invoice.client_address || '';
            document.getElementById('clientState').value = invoice.client_state || '';
            document.getElementById('clientPin').value = invoice.client_pin || '';
            document.getElementById('clientGstin').value = invoice.client_gstin || '';
            document.getElementById('clientPan').value = invoice.client_pan || '';
            
            // Restore normal section titles
            swapCompanyClientSections(false);
        }
        
        document.getElementById('invoiceNumber').value = invoice.invoice_number || '';
        document.getElementById('invoiceDate').value = invoice.invoice_date ? invoice.invoice_date.split('T')[0] : '';
        document.getElementById('dueDate').value = invoice.due_date ? invoice.due_date.split('T')[0] : '';
        document.getElementById('status').value = invoice.status || 'draft';
        
        document.getElementById('clientName').value = invoice.client_name || '';
        document.getElementById('clientEmail').value = invoice.client_email || '';
        document.getElementById('clientPhone').value = invoice.client_phone || '';
        document.getElementById('clientAddress').value = invoice.client_address || '';
        
        document.getElementById('billingCompany').value = invoice.billing_company_name || '';
        document.getElementById('billingAddress').value = invoice.billing_address || '';
        document.getElementById('billingCity').value = invoice.billing_city || '';
        document.getElementById('billingState').value = invoice.billing_state || '';
        document.getElementById('billingPin').value = invoice.billing_pin || '';
        
        document.getElementById('gstinNumber').value = invoice.gstin_number || '';
        document.getElementById('panNumber').value = invoice.pan_number || '';
        
        document.getElementById('bankName').value = invoice.bank_name || '';
        document.getElementById('accountNumber').value = invoice.account_number || '';
        document.getElementById('ifscCode').value = invoice.ifsc_code || '';
        document.getElementById('upiId').value = invoice.upi_id || '';
        
        document.getElementById('notes').value = invoice.notes || '';
        document.getElementById('termsConditions').value = invoice.terms_conditions || '';
        
        // Clear existing items
        document.getElementById('itemsContainer').innerHTML = '';
        
        // Add invoice items
        if (invoice.items && invoice.items.length > 0) {
            invoice.items.forEach(item => {
                addItem();
                const itemElements = document.querySelectorAll('.invoice-item');
                const lastItemElement = itemElements[itemElements.length - 1];
                
                if (lastItemElement) {
                    lastItemElement.querySelector('[name*="[description]"]').value = item.description || '';
                    lastItemElement.querySelector('[name*="[quantity]"]').value = item.quantity || 0;
                    lastItemElement.querySelector('[name*="[unit_price]"]').value = item.unit_price || 0;
                    lastItemElement.querySelector('[name*="[total_price]"]').value = item.total_price || 0;
                }
            });
        } else {
            // Add at least one empty item
            addItem();
        }
        
        // Calculate totals
        calculateTotals();
        
        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('invoiceModal'));
        modal.show();
        
    } catch (error) {
        console.error('Error editing invoice:', error);
        showNotification(`Error editing invoice: ${error.message}`, 'error');
    }
}

async function saveInvoice() {
    try {
        console.log('=== STARTING INVOICE SAVE ===');
        
        // Get the form
        const form = document.getElementById('invoiceForm');
        if (!form) {
            throw new Error('Invoice form not found');
        }
        
        // Check if we're editing an existing invoice
        const invoiceId = document.getElementById('invoiceId').value;
        const isEdit = invoiceId && invoiceId !== '';
        
        // Get invoice type
        const invoiceType = document.getElementById('invoiceType').value;
        
        // Collect all form data
        const formData = new FormData(form);
        const data = {};
        
        // Convert FormData to object
        for (let [key, value] of formData.entries()) {
            data[key] = value;
        }
        
        // Set invoice type in data
        data.invoice_type = invoiceType;
        
        // Handle individual vs business logic
        const invoiceCategory = document.getElementById('invoiceCategory').value;
        if (invoiceCategory === 'individual') {
            // For individual invoices, use client details as company details
            data.company_name = data.client_name;
            data.company_email = data.client_email;
            data.company_phone = data.client_phone;
            data.company_address = data.client_address;
        }
        
        // Update the button text based on whether we're creating or editing and invoice type
        const saveButton = document.querySelector('#invoiceModal .modal-footer .btn-primary');
        if (saveButton) {
            const action = isEdit ? 'Update' : 'Create';
            const type = invoiceType === 'in' ? 'In Invoice' : 'Out Invoice';
            saveButton.innerHTML = `<i class="fas fa-save me-1"></i>${action} ${type}`;
        }
        
        console.log('Basic form data collected:', data);
        
        // Collect items manually
        const items = [];
        const itemElements = document.querySelectorAll('.invoice-item');
        
        console.log('Found item elements:', itemElements.length);
        
        itemElements.forEach((itemElement, index) => {
            const descriptionInput = itemElement.querySelector('[name*="[description]"]');
            const quantityInput = itemElement.querySelector('[name*="[quantity]"]');
            const unitPriceInput = itemElement.querySelector('[name*="[unit_price]"]');
            const totalPriceInput = itemElement.querySelector('[name*="[total_price]"]');
            
            if (descriptionInput && quantityInput && unitPriceInput) {
                const item = {
                    description: descriptionInput.value,
                    quantity: parseFloat(quantityInput.value) || 0,
                    unit_price: parseFloat(unitPriceInput.value) || 0,
                    total_price: parseFloat(totalPriceInput.value) || 0
                };
                
                if (item.description && item.quantity > 0 && item.unit_price > 0) {
                    items.push(item);
                    console.log(`Item ${index + 1} collected:`, item);
                }
            }
        });
        
        data.items = items;
        console.log('Items collected:', items);
        
        // Validate required fields
        if (!data.client_name || !data.invoice_date || !data.billing_state) {
            showNotification('Please fill in all required fields (Client Name, Invoice Date, Billing State).', 'error');
            return;
        }
        
        if (items.length === 0) {
            showNotification('Please add at least one invoice item.', 'error');
            return;
        }
        
        // Calculate totals
        calculateTotals();
        
        // Get calculated values from hidden fields
        data.subtotal = parseFloat(document.getElementById('subtotalInput')?.value) || 0;
        data.cgst_amount = parseFloat(document.getElementById('cgstAmountInput')?.value) || 0;
        data.sgst_amount = parseFloat(document.getElementById('sgstAmountInput')?.value) || 0;
        data.igst_amount = parseFloat(document.getElementById('igstAmountInput')?.value) || 0;
        data.tax_amount = parseFloat(document.getElementById('taxInput')?.value) || 0;
        data.total_amount = parseFloat(document.getElementById('totalInput')?.value) || 0;
        
        // Calculate GST rates based on state
        const billingState = data.billing_state;
        if (billingState === 'Uttar Pradesh') {
            data.cgst_rate = 9;
            data.sgst_rate = 9;
            data.igst_rate = 0;
        } else if (billingState) {
            data.cgst_rate = 0;
            data.sgst_rate = 0;
            data.igst_rate = 18;
        } else {
            data.cgst_rate = 0;
            data.sgst_rate = 0;
            data.igst_rate = 0;
        }
        
        console.log('Final data to send:', data);
        
        // Set up API endpoint and method based on whether we're creating or updating
        let url = '/api/invoices';
        let method = 'POST';
        
        if (isEdit) {
            url = `/api/invoices/${invoiceId}`;
            method = 'PUT';
        }
        
        // Send to API
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        console.log('Response status:', response.status);
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const result = await response.json();
        console.log('API Response:', result);
        
        if (result.success) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('invoiceModal'));
            modal.hide();
            await loadInvoices();
            showNotification(`Invoice ${isEdit ? 'updated' : 'created'} successfully!`, 'success');
        } else {
            showNotification(result.error || `Failed to ${isEdit ? 'update' : 'create'} invoice`, 'error');
        }
        
    } catch (error) {
        console.error('Error saving invoice:', error);
        showNotification('Failed to save invoice: ' + error.message, 'error');
    }
}

async function loadInvoices() {
    try {
        console.log('Loading invoices...');
        const response = await fetch('/api/invoices');
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Invoices loaded:', data);
        
        invoices = Array.isArray(data) ? data : [];
        filteredInvoices = [...invoices];
        
        renderInvoicesTable();
        updateSummaryCards();
        
    } catch (error) {
        console.error('Error loading invoices:', error);
        showNotification('Failed to load invoices. Please try again.', 'error');
    }
}

function renderInvoicesTable() {
    const tbody = document.getElementById('invoicesTableBody');
    
    // Update the count badge in the table header
    document.getElementById('invoiceCount').textContent = filteredInvoices.length;
    
    if (filteredInvoices.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="10" class="text-center text-muted">
                    <i class="fas fa-inbox me-2"></i>No invoices found
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = filteredInvoices.map(invoice => `
        <tr>
            <td>
                <input type="checkbox" class="form-check-input invoice-checkbox" value="${invoice.id}">
            </td>
            <td>
                <code class="text-primary">${invoice.unique_id || 'N/A'}</code>
            </td>
            <td>
                <strong>${invoice.invoice_number}</strong>
            </td>
            <td>${invoice.client_name}</td>
            <td>
                <span class="badge bg-${invoice.invoice_type === 'in' ? 'success' : 'primary'}">
                    ${invoice.invoice_type === 'in' ? 'In' : 'Out'}
                </span>
            </td>
            <td>${new Date(invoice.invoice_date).toLocaleDateString()}</td>
            <td>${invoice.due_date ? new Date(invoice.due_date).toLocaleDateString() : '-'}</td>
            <td>₹${parseFloat(invoice.total_amount).toFixed(2)}</td>
            <td>
                <span class="badge bg-${getStatusColor(invoice.status)}">${invoice.status}</span>
                ${invoice.source_type === 'expense' ? '<span class="badge bg-info ms-1">From Expense</span>' : ''}
            </td>
            <td>
                <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-outline-info" onclick="viewInvoice(${invoice.id})" title="View Invoice">
                        <i class="fas fa-eye"></i>
                    </button>
                    ${invoice.source_type === 'expense' ? 
                        `<button class="btn btn-outline-success" onclick="downloadExpenseInvoice(${invoice.id})" title="Download Original File">
                            <i class="fas fa-file-download"></i>
                        </button>` :
                        `<button class="btn btn-outline-primary" onclick="downloadInvoice(${invoice.id})" title="Download PDF">
                            <i class="fas fa-download"></i>
                        </button>`
                    }
                    ${invoice.source_type !== 'expense' ? 
                        `<button class="btn btn-outline-warning" onclick="editInvoice(${invoice.id})" title="Edit Invoice">
                            <i class="fas fa-pencil-alt"></i>
                        </button>` : ''
                    }
                    <button class="btn btn-outline-secondary btn-sm" onclick="showStatusOptions(${invoice.id})" title="Update Status">
                        <i class="fas fa-exchange-alt"></i>
                    </button>
                    <div id="statusOptions${invoice.id}" class="status-options-container" style="display:none;">
                        <div class="status-options">
                            <button class="btn btn-sm btn-outline-success mb-1 w-100" onclick="updateInvoiceStatus(${invoice.id}, 'paid'); hideStatusOptions(${invoice.id})"><i class="fas fa-check me-2"></i>Mark as Paid</button>
                            <button class="btn btn-sm btn-outline-primary mb-1 w-100" onclick="updateInvoiceStatus(${invoice.id}, 'sent'); hideStatusOptions(${invoice.id})"><i class="fas fa-paper-plane me-2"></i>Mark as Sent</button>
                            <button class="btn btn-sm btn-outline-danger mb-1 w-100" onclick="updateInvoiceStatus(${invoice.id}, 'overdue'); hideStatusOptions(${invoice.id})"><i class="fas fa-exclamation-circle me-2"></i>Mark as Overdue</button>
                            <button class="btn btn-sm btn-outline-secondary w-100" onclick="updateInvoiceStatus(${invoice.id}, 'draft'); hideStatusOptions(${invoice.id})"><i class="fas fa-file me-2"></i>Mark as Draft</button>
                        </div>
                    </div>
                    <button class="btn btn-outline-success" onclick="generateReceipt('invoice', ${invoice.id})" title="Generate Receipt">
                        <i class="fas fa-receipt"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="deleteInvoice(${invoice.id})" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
    
    // Initialize Bootstrap dropdowns after rendering
    initializeDropdowns();
}

function getStatusColor(status) {
    switch (status) {
        case 'paid': return 'success';
        case 'sent': return 'primary';
        case 'draft': return 'secondary';
        case 'overdue': return 'danger';
        default: return 'secondary';
    }
}

function updateSummaryCards() {
    const totalInvoices = invoices.length;
    const inInvoices = invoices.filter(inv => inv.invoice_type === 'in');
    const outInvoices = invoices.filter(inv => inv.invoice_type === 'out' || !inv.invoice_type);
    const paidInvoices = invoices.filter(inv => inv.status === 'paid');
    const pendingInvoices = invoices.filter(inv => inv.status === 'sent' || inv.status === 'draft');
    const overdueInvoices = invoices.filter(inv => inv.status === 'overdue');
    
    // Calculate total amounts
    const totalAmount = invoices.reduce((sum, inv) => sum + parseFloat(inv.total_amount), 0);
    const inAmount = inInvoices.reduce((sum, inv) => sum + parseFloat(inv.total_amount), 0);
    const outAmount = outInvoices.reduce((sum, inv) => sum + parseFloat(inv.total_amount), 0);
    const paidAmount = paidInvoices.reduce((sum, inv) => sum + parseFloat(inv.total_amount), 0);
    const pendingAmount = pendingInvoices.reduce((sum, inv) => sum + parseFloat(inv.total_amount), 0);
    const overdueAmount = overdueInvoices.reduce((sum, inv) => sum + parseFloat(inv.total_amount), 0);
    
    // Update the total invoices count and amounts
    document.getElementById('totalInvoices').innerHTML = `${totalInvoices} <small style="font-size: 0.7em; color: #6c757d;">(In: ${inInvoices.length} | Out: ${outInvoices.length})</small>`;
    document.getElementById('totalInAmount').textContent = `₹${inAmount.toFixed(2)}`;
    document.getElementById('totalOutAmount').textContent = `₹${outAmount.toFixed(2)}`;
    
    // Update paid invoices with count and amount
    document.getElementById('paidInvoiceCount').textContent = paidInvoices.length;
    document.getElementById('paidAmount').textContent = `₹${paidAmount.toFixed(2)}`;
    
    // Update pending invoices with count and amount
    document.getElementById('pendingInvoiceCount').textContent = pendingInvoices.length;
    document.getElementById('pendingAmount').textContent = `₹${pendingAmount.toFixed(2)}`;
    
    // Update overdue invoices with count and amount
    document.getElementById('overdueInvoiceCount').textContent = overdueInvoices.length;
    document.getElementById('overdueAmount').textContent = `₹${overdueAmount.toFixed(2)}`;
    
    // Update the invoice count in the table header
    document.getElementById('invoiceCount').textContent = filteredInvoices.length;
}

function searchInvoices() {
    const searchTerm = document.getElementById('invoiceSearch').value.toLowerCase();
    const uniqueIdFilter = document.getElementById('filterInvoiceUniqueId').value.toLowerCase();
    const statusFilter = document.getElementById('filterInvoiceStatus').value;
    const typeFilter = document.getElementById('filterInvoiceType').value;
    const dateFrom = document.getElementById('filterInvoiceDateFrom').value;
    const dateTo = document.getElementById('filterInvoiceDateTo').value;
    
    filteredInvoices = invoices.filter(invoice => {
        const matchesSearch = invoice.invoice_number.toLowerCase().includes(searchTerm) ||
                            invoice.client_name.toLowerCase().includes(searchTerm);
        const matchesUniqueId = !uniqueIdFilter || (invoice.unique_id && invoice.unique_id.toLowerCase().includes(uniqueIdFilter));
        const matchesStatus = !statusFilter || invoice.status === statusFilter;
        const matchesType = !typeFilter || invoice.invoice_type === typeFilter;
        
        let matchesDateRange = true;
        if (dateFrom || dateTo) {
            const invoiceDate = new Date(invoice.invoice_date);
            if (dateFrom && invoiceDate < new Date(dateFrom)) matchesDateRange = false;
            if (dateTo && invoiceDate > new Date(dateTo)) matchesDateRange = false;
        }
        
        return matchesSearch && matchesUniqueId && matchesStatus && matchesType && matchesDateRange;
    });
    
    renderInvoicesTable();
}

function filterInvoices() {
    searchInvoices();
}

function clearFilters() {
    document.getElementById('invoiceSearch').value = '';
    document.getElementById('filterInvoiceUniqueId').value = '';
    document.getElementById('filterInvoiceStatus').value = '';
    document.getElementById('filterInvoiceType').value = '';
    document.getElementById('filterInvoiceDateFrom').value = '';
    document.getElementById('filterInvoiceDateTo').value = '';
    filteredInvoices = [...invoices];
    renderInvoicesTable();
}

function generateReceipt(transactionType, transactionId) {
    try {
        // Open receipt in new window
        const receiptUrl = `/api/receipt/${transactionType}/${transactionId}`;
        window.open(receiptUrl, '_blank', 'width=800,height=600,scrollbars=yes,resizable=yes');
    } catch (error) {
        console.error('Error generating receipt:', error);
        ExpenseTracker.showNotification('Error generating receipt: ' + error.message, 'error');
    }
}

function downloadInvoice(id) {
    // Create a temporary link element to trigger download
    const link = document.createElement('a');
    link.href = `/api/invoices/${id}/pdf`;
    link.download = `invoice_${id}.pdf`;
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function downloadExpenseInvoice(id) {
    // For expense-generated invoices, download the original uploaded file
    const link = document.createElement('a');
    link.href = `/api/invoices/${id}/expense-file`;
    link.download = `expense_invoice_${id}`;
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

async function changeInvoiceStatus(id, newStatus) {
    if (!newStatus) return;
    
    try {
        const response = await fetch(`/api/invoices/${id}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ status: newStatus })
        });
        
        if (response.ok) {
            await loadInvoices();
            showNotification(`Invoice status updated to ${newStatus} successfully!`, 'success');
        } else {
            showNotification('Failed to update invoice status', 'error');
        }
    } catch (error) {
        console.error('Error updating invoice status:', error);
        showNotification('Failed to update invoice status', 'error');
    }
}

// Add the missing updateInvoiceStatus function that is called from the HTML
async function updateInvoiceStatus(id, newStatus) {
    await changeInvoiceStatus(id, newStatus);
}

async function deleteInvoice(id) {
    // Use custom modal instead of browser confirm
    showDeleteConfirmation(
        'Are you sure you want to delete this invoice?',
        'invoice',
        async () => {
            try {
                const response = await fetch(`/api/invoices/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    await loadInvoices();
                    showNotification('Invoice deleted successfully!', 'success');
                } else {
                    showNotification('Failed to delete invoice', 'error');
                }
            } catch (error) {
                console.error('Error deleting invoice:', error);
                showNotification('Failed to delete invoice', 'error');
            }
        }
    );
}

async function testInvoiceAPI() {
    try {
        console.log('Testing invoice API...');
        const response = await fetch('/api/invoices');
        const data = await response.json();
        console.log('API Response:', data);
        showNotification(`API Test Successful! Found ${Array.isArray(data) ? data.length : 0} invoices.`, 'success');
    } catch (error) {
        console.error('API Test Failed:', error);
        showNotification(`API Test Failed: ${error.message}`, 'error');
    }
}

function showDeleteConfirmation(message, type, onConfirm) {
    document.getElementById('deleteConfirmMessage').textContent = message;
    const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    
    const confirmBtn = document.getElementById('confirmDeleteBtn');
    confirmBtn.onclick = () => {
        modal.hide();
        onConfirm();
    };
    
    modal.show();
}

function showStatusOptions(id) {
    // Close any open status options first
    document.querySelectorAll('.status-options-container').forEach(container => {
        container.style.display = 'none';
    });
    
    // Show this status options
    const optionsContainer = document.getElementById(`statusOptions${id}`);
    if (optionsContainer) {
        optionsContainer.style.display = 'block';
    }
}

function hideStatusOptions(id) {
    const optionsContainer = document.getElementById(`statusOptions${id}`);
    if (optionsContainer) {
        optionsContainer.style.display = 'none';
    }
}

// Close status options when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.closest('.status-options-container') && !event.target.closest('button[onclick^="showStatusOptions"]')) {
        document.querySelectorAll('.status-options-container').forEach(container => {
            container.style.display = 'none';
        });
    }
});

function initializeDropdowns() {
    // No longer needed with our custom approach
}



// Function to open invoice modal with specific type
function openInvoiceModal(type) {
    // Reset form
    document.getElementById('invoiceForm').reset();
    document.getElementById('itemsContainer').innerHTML = '';
    document.getElementById('invoiceId').value = '';
    document.getElementById('invoiceType').value = type;
    
    // Set default category to business and show company fields
    document.getElementById('invoiceCategory').value = 'business';
    toggleCompanyFields();
    
    // Update modal title and button text based on type
    if (type === 'in') {
        document.getElementById('invoiceModal').querySelector('.modal-title').innerHTML = '<i class="fas fa-plus me-2"></i>Create In Invoice';
        const saveButton = document.querySelector('#invoiceModal .modal-footer .btn-primary');
        if (saveButton) {
            saveButton.innerHTML = '<i class="fas fa-save me-1"></i>Create In Invoice';
        }
        // Swap Company and Client sections for In invoice
        swapCompanyClientSections(true);
    } else {
        document.getElementById('invoiceModal').querySelector('.modal-title').innerHTML = '<i class="fas fa-plus me-2"></i>Create Out Invoice';
        const saveButton = document.querySelector('#invoiceModal .modal-footer .btn-primary');
        if (saveButton) {
            saveButton.innerHTML = '<i class="fas fa-save me-1"></i>Create Out Invoice';
        }
        // Restore normal order for Out invoice
        swapCompanyClientSections(false);
    }
    
    // Add first item
    addItem();
    calculateTotals();
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('invoiceModal'));
    modal.show();
}

// Function to toggle company fields based on invoice category
function toggleCompanyFields() {
    const category = document.getElementById('invoiceCategory').value;
    const companySection = document.getElementById('companySection');
    const companyFields = [
        'companyNameField',
        'companyEmailField', 
        'companyPhoneField',
        'companyAddressField'
    ];
    
    if (category === 'individual') {
        // Hide company section and fields
        companySection.classList.add('hidden');
        companyFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.classList.add('company-field-hidden');
                // Clear values and remove required attribute
                const input = field.querySelector('input, textarea');
                if (input) {
                    input.value = '';
                    input.removeAttribute('required');
                }
            }
        });
        
        // Update company name to use client name for individual invoices
        const clientName = document.getElementById('clientName').value;
        if (clientName) {
            document.getElementById('companyName').value = clientName;
        }
    } else if (category === 'business') {
        // Show company section and fields
        companySection.classList.remove('hidden');
        companyFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.classList.remove('company-field-hidden');
                // Add required attribute back to company name
                if (fieldId === 'companyNameField') {
                    const input = field.querySelector('input');
                    if (input) {
                        input.setAttribute('required', 'required');
                    }
                }
            }
        });
    }
}

// Function to swap Company and Client sections for In invoices
function swapCompanyClientSections(isInInvoice) {
    const companySection = document.querySelector('#companyName').closest('.col-md-6').parentNode;
    const clientSection = document.querySelector('#clientName').closest('.col-md-6').parentNode;
    
    if (isInInvoice) {
        // Change section titles
        companySection.querySelector('h6').innerHTML = '<i class="fas fa-building me-2"></i>Vendor Information';
        clientSection.querySelector('h6').innerHTML = '<i class="fas fa-user me-2"></i>Your Information';
    } else {
        // Restore original section titles
        companySection.querySelector('h6').innerHTML = '<i class="fas fa-building me-2"></i>Company Information';
        clientSection.querySelector('h6').innerHTML = '<i class="fas fa-user me-2"></i>Client Information';
    }
}

// Reset form when modal is closed
document.getElementById('invoiceModal').addEventListener('hidden.bs.modal', function() {
    document.getElementById('invoiceForm').reset();
    document.getElementById('itemsContainer').innerHTML = '';
    document.getElementById('invoiceId').value = '';
    document.getElementById('invoiceType').value = 'out';
    document.getElementById('invoiceModal').querySelector('.modal-title').innerHTML = '<i class="fas fa-plus me-2"></i>Create Out Invoice';
    
    // Reset the save button text
    const saveButton = document.querySelector('#invoiceModal .modal-footer .btn-primary');
    if (saveButton) {
        saveButton.innerHTML = '<i class="fas fa-save me-1"></i>Create Out Invoice';
    }
    
    // Reset category to business and show company fields
    document.getElementById('invoiceCategory').value = 'business';
    toggleCompanyFields();
    
    // Restore normal section titles
    swapCompanyClientSections(false);
    
    addItem();
    calculateTotals();
});

// Bank Management Functions for Invoice Form
let userBanks = [];

// Load user banks when modal opens
document.getElementById('invoiceModal').addEventListener('show.bs.modal', function() {
    loadUserBanks();
});

// Add event listener for client name changes to update company name for individual invoices
document.addEventListener('DOMContentLoaded', function() {
    const clientNameField = document.getElementById('clientName');
    if (clientNameField) {
        clientNameField.addEventListener('input', function() {
            const category = document.getElementById('invoiceCategory').value;
            if (category === 'individual') {
                document.getElementById('companyName').value = this.value;
            }
        });
    }
});

async function loadUserBanks() {
    try {
        const response = await fetch('/api/user-banks');
        if (response.ok) {
            userBanks = await response.json();
            populateBankDropdown();
        } else {
            console.error('Failed to load user banks');
        }
    } catch (error) {
        console.error('Error loading user banks:', error);
    }
}

function populateBankDropdown() {
    const dropdown = document.getElementById('selectedBank');
    dropdown.innerHTML = '<option value="">Choose a bank account...</option>';
    
    userBanks.forEach(bank => {
        const option = document.createElement('option');
        option.value = bank.id;
        option.textContent = `${bank.bank_name} - ${bank.account_number}`;
        dropdown.appendChild(option);
    });
}

function fillBankDetails() {
    const selectedBankId = document.getElementById('selectedBank').value;
    const selectedBank = userBanks.find(bank => bank.id == selectedBankId);
    
    if (selectedBank) {
        document.getElementById('bankName').value = selectedBank.bank_name;
        document.getElementById('accountNumber').value = selectedBank.account_number;
        document.getElementById('ifscCode').value = selectedBank.ifsc_code;
        document.getElementById('upiId').value = selectedBank.upi_id || '';
        document.getElementById('bankAccountId').value = selectedBank.id;
    } else {
        // Clear fields if no bank selected
        document.getElementById('bankName').value = '';
        document.getElementById('accountNumber').value = '';
        document.getElementById('ifscCode').value = '';
        document.getElementById('upiId').value = '';
        document.getElementById('bankAccountId').value = '';
    }
}
// Bulk operations functionality
function updateBulkButtons() {
    const checkboxes = document.querySelectorAll('.invoice-checkbox:checked');
    const bulkDeleteBtn = document.getElementById('bulkDeleteInvoices');
    const bulkExportBtn = document.getElementById('bulkExportInvoices');
    const selectedCount = document.getElementById('selectedInvoicesCount');
    const selectedDeleteCount = document.getElementById('selectedInvoicesDeleteCount');
    
    const count = checkboxes.length;
    selectedCount.textContent = count;
    selectedDeleteCount.textContent = count;
    const showButtons = count > 0;
    bulkDeleteBtn.style.display = showButtons ? 'block' : 'none';
    bulkExportBtn.style.display = showButtons ? 'block' : 'none';
}

// Select all functionality
document.addEventListener('DOMContentLoaded', function() {
    const selectAllCheckbox = document.getElementById('selectAllInvoices');
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.invoice-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateBulkButtons();
        });
    }
    
    // Add event listeners to individual checkboxes
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('invoice-checkbox')) {
            updateBulkButtons();
        }
    });
});

async function bulkExportInvoices() {
    const selectedCheckboxes = document.querySelectorAll('.invoice-checkbox:checked');
    const selectedIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));
    
    if (selectedIds.length === 0) {
        showNotification('No invoices selected for export.', 'warning');
        return;
    }
    
    try {
        // Show loading state
        const exportBtn = document.getElementById('bulkExportInvoices');
        const originalText = exportBtn.innerHTML;
        exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Exporting...';
        exportBtn.disabled = true;
        
        // Create a form to submit the selected IDs
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/api/invoices/export';
        form.target = '_blank';
        
        // Add selected IDs as hidden inputs
        selectedIds.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'invoice_ids';
            input.value = id;
            form.appendChild(input);
        });
        
        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);
        
        showNotification(`Exporting ${selectedIds.length} selected invoice(s) to PDF...`, 'success');
        
        // Reset button state after a delay
        setTimeout(() => {
            exportBtn.innerHTML = originalText;
            exportBtn.disabled = false;
        }, 2000);
        
    } catch (error) {
        console.error('Error exporting invoices:', error);
        showNotification('Error exporting invoices: ' + error.message, 'error');
        
        // Reset button state
        const exportBtn = document.getElementById('bulkExportInvoices');
        exportBtn.innerHTML = '<i class="fas fa-file-pdf me-1"></i>Export Selected (<span id="selectedInvoicesCount">0</span>)';
        exportBtn.disabled = false;
    }
}

async function bulkDeleteInvoices() {
    const selectedCheckboxes = document.querySelectorAll('.invoice-checkbox:checked');
    const selectedIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));
    
    if (selectedIds.length === 0) {
        showNotification('No invoices selected for deletion.', 'warning');
        return;
    }
    
    // Use styled delete confirmation modal instead of basic confirm()
    ExpenseTracker.showDeleteConfirmation(
        `Are you sure you want to delete ${selectedIds.length} selected invoice(s)? This action cannot be undone.`,
        'invoices',
        async () => {
        try {
            // Show loading state
            const deleteBtn = document.getElementById('bulkDeleteInvoices');
            const originalText = deleteBtn.innerHTML;
            deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Deleting...';
            deleteBtn.disabled = true;
            
            // Delete all selected invoices sequentially to avoid race conditions
            let successCount = 0;
            let errorCount = 0;
            
            for (const id of selectedIds) {
                try {
                    await axios.delete(`/api/invoices/${id}`);
                    successCount++;
                } catch (error) {
                    console.error(`Error deleting invoice ${id}:`, error);
                    errorCount++;
                }
            }
            
            // Reload invoices and update UI
            await loadInvoices();
            
            // Reset button state
            deleteBtn.innerHTML = originalText;
            deleteBtn.disabled = false;
            
            // Reset select all checkbox
            document.getElementById('selectAllInvoices').checked = false;
            updateBulkButtons();
            
            // Show result notification
            if (errorCount === 0) {
                showNotification(`${successCount} invoice(s) deleted successfully!`, 'success');
            } else if (successCount > 0) {
                showNotification(`${successCount} invoice(s) deleted successfully, ${errorCount} failed.`, 'warning');
            } else {
                showNotification(`Failed to delete invoices. Please try again.`, 'error');
            }
            
        } catch (error) {
            console.error('Error in bulk delete:', error);
            showNotification('Error deleting invoices: ' + (error.response?.data?.error || error.message), 'error');
            
            // Reset button state
            const deleteBtn = document.getElementById('bulkDeleteInvoices');
            deleteBtn.innerHTML = '<i class="fas fa-trash me-1"></i>Delete Selected (<span id="selectedInvoicesDeleteCount">0</span>)';
            deleteBtn.disabled = false;
        }
        }
    );
}

function viewInvoice(id) {
    try {
        console.log('Viewing invoice with ID:', id);
        console.log('Available invoices:', invoices);
        
        const invoice = invoices.find(i => i.id === parseInt(id));
        if (!invoice) {
            console.error('Invoice not found with ID:', id);
            showNotification('Invoice not found!', 'error');
            return;
        }
        
        console.log('Found invoice:', invoice);
        
        const detailsDiv = document.getElementById('invoiceDetails');
        if (!detailsDiv) {
            console.error('invoiceDetails element not found');
            showNotification('Error loading invoice details!', 'error');
            return;
        }
        
        const invoiceDate = new Date(invoice.invoice_date).toLocaleDateString();
        const dueDate = invoice.due_date ? new Date(invoice.due_date).toLocaleDateString() : 'N/A';
        const createdDate = invoice.created_at ? new Date(invoice.created_at).toLocaleString() : 'N/A';
        
        detailsDiv.innerHTML = `
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label"><strong>Invoice Number:</strong></label>
                    <p class="form-control-plaintext"><code>${invoice.invoice_number || 'N/A'}</code></p>
                </div>
                <div class="col-md-6">
                    <label class="form-label"><strong>Unique ID:</strong></label>
                    <p class="form-control-plaintext"><code>${invoice.unique_id || 'N/A'}</code></p>
                </div>
                <div class="col-md-6">
                    <label class="form-label"><strong>Client Name:</strong></label>
                    <p class="form-control-plaintext">${invoice.client_name || 'N/A'}</p>
                </div>
                <div class="col-md-6">
                    <label class="form-label"><strong>Client Email:</strong></label>
                    <p class="form-control-plaintext">${invoice.client_email || 'N/A'}</p>
                </div>
                <div class="col-md-6">
                    <label class="form-label"><strong>Invoice Type:</strong></label>
                    <p class="form-control-plaintext">
                        <span class="badge bg-${invoice.invoice_type === 'in' ? 'success' : 'primary'}">
                            ${invoice.invoice_type === 'in' ? 'Incoming' : 'Outgoing'}
                        </span>
                    </p>
                </div>
                <div class="col-md-6">
                    <label class="form-label"><strong>Status:</strong></label>
                    <p class="form-control-plaintext">
                        <span class="badge bg-${getStatusColor(invoice.status)}">${invoice.status || 'N/A'}</span>
                        ${invoice.source_type === 'expense' ? '<span class="badge bg-info ms-1">From Expense</span>' : ''}
                    </p>
                </div>
                <div class="col-md-6">
                    <label class="form-label"><strong>Invoice Date:</strong></label>
                    <p class="form-control-plaintext">${invoiceDate}</p>
                </div>
                <div class="col-md-6">
                    <label class="form-label"><strong>Due Date:</strong></label>
                    <p class="form-control-plaintext">${dueDate}</p>
                </div>
                <div class="col-md-6">
                    <label class="form-label"><strong>Subtotal:</strong></label>
                    <p class="form-control-plaintext">₹${parseFloat(invoice.subtotal || 0).toFixed(2)}</p>
                </div>
                <div class="col-md-6">
                    <label class="form-label"><strong>Tax Amount:</strong></label>
                    <p class="form-control-plaintext">₹${parseFloat(invoice.tax_amount || 0).toFixed(2)}</p>
                </div>
                <div class="col-md-6">
                    <label class="form-label"><strong>Total Amount:</strong></label>
                    <p class="form-control-plaintext"><strong>₹${parseFloat(invoice.total_amount || 0).toFixed(2)}</strong></p>
                </div>
                <div class="col-md-6">
                    <label class="form-label"><strong>Created At:</strong></label>
                    <p class="form-control-plaintext">${createdDate}</p>
                </div>
                ${invoice.notes ? `
                <div class="col-12">
                    <label class="form-label"><strong>Notes:</strong></label>
                    <p class="form-control-plaintext">${invoice.notes}</p>
                </div>
                ` : ''}
                ${invoice.client_address ? `
                <div class="col-12">
                    <label class="form-label"><strong>Client Address:</strong></label>
                    <p class="form-control-plaintext">${invoice.client_address}</p>
                </div>
                ` : ''}
            </div>
        `;
        
        const modal = new bootstrap.Modal(document.getElementById('viewInvoiceModal'));
        modal.show();
        
    } catch (error) {
        console.error('Error in viewInvoice:', error);
        showNotification('Error loading invoice details: ' + error.message, 'error');
    }
}

</script>
{% endblock %}

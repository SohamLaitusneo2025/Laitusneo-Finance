
{% extends "base.html" %}

{% block title %}Transactions{% endblock %}

{% block content %}
<style>
/* Beautiful Table Styling - Maintaining Original UI */
#transactionsTable {
    width: 100%;
    table-layout: fixed;
    border-collapse: collapse;
    background-color: #fff;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

#transactionsTable th,
#transactionsTable td {
    padding: 10px 12px;
    font-size: 0.9rem;
    vertical-align: middle;
    border-bottom: 1px solid #e9ecef;
    text-align: left;
}

#transactionsTable thead th {
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
    font-weight: 600;
    color: #495057;
    position: sticky;
    top: 0;
    z-index: 10;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

#transactionsTable tbody tr {
    transition: background-color 0.2s ease;
}

#transactionsTable tbody tr:hover {
    background-color: #f8f9fa;
}

#transactionsTable tbody tr:last-child td {
    border-bottom: none;
}

/* Column width management - Optimized for single page */
#transactionsTable th:nth-child(1), #transactionsTable td:nth-child(1) { width: 4%; } /* Checkbox */
#transactionsTable th:nth-child(2), #transactionsTable td:nth-child(2) { width: 14%; } /* Unique ID */
#transactionsTable th:nth-child(3), #transactionsTable td:nth-child(3) { width: 20%; } /* Title */
#transactionsTable th:nth-child(4), #transactionsTable td:nth-child(4) { width: 10%; } /* Amount */
#transactionsTable th:nth-child(5), #transactionsTable td:nth-child(5) { width: 8%; } /* Type */
#transactionsTable th:nth-child(6), #transactionsTable td:nth-child(6) { width: 8%; } /* Payment */
#transactionsTable th:nth-child(7), #transactionsTable td:nth-child(7) { width: 10%; } /* UTR Number */
#transactionsTable th:nth-child(8), #transactionsTable td:nth-child(8) { width: 8%; } /* Date */
#transactionsTable th:nth-child(9), #transactionsTable td:nth-child(9) { width: 7%; } /* Receipt */
#transactionsTable th:nth-child(10), #transactionsTable td:nth-child(10) { width: 11%; } /* Actions */

/* Better action buttons - Fixed overflow */
#transactionsTable .btn-group-sm {
    display: flex;
    gap: 1px;
    flex-wrap: nowrap;
    width: 100%;
    justify-content: center;
}

#transactionsTable .btn-group-sm .btn {
    padding: 0.3rem 0.4rem;
    font-size: 0.75rem;
    line-height: 1;
    border-radius: 3px;
    min-width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex: 1;
    max-width: 30px;
}

/* Responsive adjustments */
@media (max-width: 1200px) {
    #transactionsTable th, #transactionsTable td {
        padding: 8px 10px;
        font-size: 0.85rem;
    }
    
    #transactionsTable .btn-group-sm .btn {
        padding: 0.25rem 0.3rem;
        font-size: 0.7rem;
        min-width: 26px;
        height: 26px;
        max-width: 28px;
    }
}

@media (max-width: 768px) {
    #transactionsTable th, #transactionsTable td {
        padding: 6px 8px;
        font-size: 0.8rem;
    }
    
    #transactionsTable .btn-group-sm .btn {
        padding: 0.2rem 0.25rem;
        font-size: 0.65rem;
        min-width: 22px;
        height: 22px;
        max-width: 24px;
    }
}
</style>

<div class="professional-dashboard">
    <!-- Header Section -->
    <div class="header-section">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center">
                <div class="page-header">
                    <!-- Removed title and subtitle -->
                </div>
                <div class="action-buttons">
                    <button class="btn btn-outline-secondary search-toggle-btn me-2" id="searchToggleBtn" onclick="toggleSearch()">
                        <i class="fas fa-search"></i>
                    </button>
                    <button class="btn btn-primary add-btn" data-bs-toggle="modal" data-bs-target="#transactionModal">
                        <i class="fas fa-plus me-2"></i>Add Transaction
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Cards Section -->
    <div class="metrics-section">
        <div class="container-fluid">
            <div class="row g-4">
                <div class="col-lg-4 col-md-6">
                    <div class="metric-card success">
                        <div class="metric-icon">
                            <i class="fas fa-arrow-up"></i>
                        </div>
                        <div class="metric-content">
                            <h3 class="metric-value" id="totalCredits">₹0.00</h3>
                            <p class="metric-label">Total Credits</p>
                            <small class="metric-description">Money received</small>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 col-md-6">
                    <div class="metric-card warning">
                        <div class="metric-icon">
                            <i class="fas fa-arrow-down"></i>
                        </div>
                        <div class="metric-content">
                            <h3 class="metric-value" id="totalDebits">₹0.00</h3>
                            <p class="metric-label">Total Debits</p>
                            <small class="metric-description">Money spent</small>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 col-md-6">
                    <div class="metric-card net-balance-card">
                        <div class="metric-icon">
                            <i class="fas fa-balance-scale"></i>
                        </div>
                        <div class="metric-content">
                            <h3 class="metric-value" id="netBalance">₹0.00</h3>
                            <p class="metric-label">Net Balance</p>
                            <small class="metric-description">Credits - Debits</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <!-- Filters Section -->
    <div class="filters-section" id="filtersSection" style="display: none;">
        <div class="container-fluid">
            <div class="filter-card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="fas fa-filter me-2"></i>Filter Options
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-2">
                            <label for="filterTransactionUniqueId" class="form-label">Unique ID</label>
                            <input type="text" class="form-control" id="filterTransactionUniqueId" placeholder="Search by ID..." onkeyup="filterTransactions()">
                        </div>
                        <div class="col-md-2">
                            <label for="filterTransactionType" class="form-label">Type</label>
                            <select class="form-select" id="filterTransactionType" onchange="filterTransactions()">
                                <option value="">All Types</option>
                                <option value="credit">Credit</option>
                                <option value="debit">Debit</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="filterTransactionCategory" class="form-label">Category</label>
                            <input type="text" class="form-control" id="filterTransactionCategory" placeholder="Category..." onkeyup="filterTransactions()">
                        </div>
                        <div class="col-md-2">
                            <label for="filterTransactionBankAccount" class="form-label">Bank Account</label>
                            <select class="form-select" id="filterTransactionBankAccount" onchange="filterTransactions()">
                                <option value="">All Accounts</option>
                                <option value="cash">Cash</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="filterTransactionDateFrom" class="form-label">From Date</label>
                            <input type="date" class="form-control" id="filterTransactionDateFrom" onchange="filterTransactions()">
                        </div>
                        <div class="col-md-2">
                            <label for="filterTransactionDateTo" class="form-label">To Date</label>
                            <input type="date" class="form-control" id="filterTransactionDateTo" onchange="filterTransactions()">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transactions Table Section -->
    <div class="table-section">
        <div class="container-fluid">
            <div class="table-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title">
                        <i class="fas fa-list me-2"></i>All Transactions
                        <span class="badge bg-primary ms-2" id="transactionCount">0</span>
                    </h5>
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-success btn-sm" id="bulkExportTransactions" style="display: none;" onclick="bulkExportTransactions()">
                            <i class="fas fa-file-pdf me-1"></i>Export Selected (<span id="selectedTransactionsCount">0</span>)
                        </button>
                        <button class="btn btn-outline-danger btn-sm" id="bulkDeleteTransactions" style="display: none;" onclick="bulkDeleteTransactions()">
                            <i class="fas fa-trash me-1"></i>Delete Selected (<span id="selectedTransactionsDeleteCount">0</span>)
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table class="detail-table" id="transactionsTable">
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" id="selectAllTransactions" class="form-check-input" title="Select All">
                        </th>
                        <th>Unique ID</th>
                        <th>Title</th>
                        <th>Amount</th>
                        <th>Type</th>
                        <th>Payment</th>
                        <th>UTR Number</th>
                        <th>Date</th>
                        <th>Receipt</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
        <div class="text-center py-4" id="noTransactions" style="display: none;">
            <i class="fas fa-exchange-alt fa-3x text-muted mb-3"></i>
            <p class="text-muted">No transactions found.</p>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#transactionModal">
                <i class="fas fa-plus me-1"></i>Add First Transaction
            </button>
        </div>
    </div>
</div>

<!-- Add/Edit Transaction Modal -->
<div class="modal fade" id="transactionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="transactionModalTitle">
                    <i class="fas fa-plus me-2"></i>Add Transaction
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="transactionForm" enctype="multipart/form-data">
                    <input type="hidden" id="transactionId" name="transaction_id">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="transactionTitle" class="form-label">Title *</label>
                            <input type="text" class="form-control" id="transactionTitle" name="title" required>
                        </div>
                        <div class="col-md-6">
                            <label for="transactionAmount" class="form-label">Amount *</label>
                            <div class="input-group">
                                <span class="input-group-text">₹</span>
                                <input type="number" class="form-control" id="transactionAmount" name="amount" step="0.01" min="0" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="transactionType" class="form-label">Type *</label>
                            <select class="form-select" id="transactionType" name="transaction_type" required>
                                <option value="">Select Type</option>
                                <option value="credit">Credit (Money In)</option>
                                <option value="debit">Debit (Money Out)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="transactionCategory" class="form-label">Category</label>
                            <input type="text" class="form-control" id="transactionCategory" name="category" list="transactionCategoryOptions">
                            <datalist id="transactionCategoryOptions">
                                <option value="Salary">
                                <option value="Investment">
                                <option value="Business Income">
                                <option value="Bills">
                                <option value="Groceries">
                                <option value="Transportation">
                                <option value="Entertainment">
                                <option value="Healthcare">
                                <option value="Other">
                            </datalist>
                        </div>
                        <div class="col-md-6">
                            <label for="transactionPurpose" class="form-label">Purpose *</label>
                            <input type="text" class="form-control" id="transactionPurpose" name="purpose" required placeholder="Purpose of transaction">
                        </div>
                        <div class="col-md-6">
                            <label for="transactionPaymentMethod" class="form-label">Payment Method *</label>
                            <select class="form-select" id="transactionPaymentMethod" name="payment_method" required onchange="toggleTransactionBankSelection()">
                                <option value="cash">Cash</option>
                                <option value="online">Online</option>
                            </select>
                        </div>
                        <div class="col-md-6" id="transactionBankSelectionDiv" style="display: none;">
                            <label for="transactionBankAccount" class="form-label">Bank Account *</label>
                            <select class="form-select" id="transactionBankAccount" name="bank_account_id">
                                <option value="">Choose a bank account...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="transactionDate" class="form-label">Date *</label>
                            <input type="date" class="form-control" id="transactionDate" name="transaction_date" required>
                        </div>
                        <div class="col-md-6">
                            <label for="transactionUtrNumber" class="form-label">UTR Number</label>
                            <input type="text" class="form-control" id="transactionUtrNumber" name="utr_number" placeholder="UTR/Reference Number (Optional)">
                        </div>
                        <div class="col-md-6">
                            <label for="receiptFile" class="form-label">Receipt/Proof</label>
                            <input type="file" class="form-control" id="receiptFile" name="receipt_file" accept=".pdf,.png,.jpg,.jpeg,.gif,.doc,.docx">
                            <div class="form-text">Optional. Supported formats: PDF, Images, Word documents</div>
                        </div>
                        <div class="col-12">
                            <label for="transactionDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="transactionDescription" name="description" rows="3" placeholder="Additional details about the transaction..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveTransaction()">
                    <i class="fas fa-save me-1"></i>Save Transaction
                </button>
            </div>
        </div>
    </div>
</div>

<!-- View Transaction Modal -->
<div class="modal fade" id="viewTransactionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-eye me-2"></i>Transaction Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="transactionDetails">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let transactions = [];
let filteredTransactions = [];
let editingTransactionId = null;

// Load transactions on page load
document.addEventListener('DOMContentLoaded', function() {
    // Set today's date as default
    document.getElementById('transactionDate').valueAsDate = new Date();
    
    // Initialize the net balance card with default colors
    const balanceCard = document.querySelector('.net-balance-card');
    if (balanceCard) {
        balanceCard.style.setProperty('--metric-color', '#06b6d4');
        balanceCard.style.setProperty('--metric-color-light', '#22d3ee');
        balanceCard.style.setProperty('--metric-color-rgb', '6, 182, 212');
    }
    
    loadTransactions();
});

async function loadTransactions() {
    try {
        const response = await axios.get('/api/transactions');
        transactions = response.data;
        filteredTransactions = [...transactions];
        renderTransactionsTable();
        await updateSummaryCards();
    } catch (error) {
        console.error('Error loading transactions:', error);
        alert('Error loading transactions: ' + (error.response?.data?.error || error.message));
    }
}

async function updateSummaryCards() {
    try {
        // Get dashboard stats to get accurate credit/debit calculations
        const response = await axios.get('/api/dashboard/stats');
        const stats = response.data;
        
        // Calculate total credits = cash credits + bank credits
        const totalCredits = parseFloat(stats.transactions.cash_credits || 0) + parseFloat(stats.transactions.bank_credits || 0);
        
        // Calculate total debits = cash debits + bank debits  
        const totalDebits = parseFloat(stats.transactions.cash_debits || 0) + parseFloat(stats.transactions.bank_debits || 0);
        
        // Net balance = current balance (cash + bank balances)
        const netBalance = parseFloat(stats.balance || 0);
        
        document.getElementById('totalCredits').textContent = `₹${totalCredits.toFixed(2)}`;
        document.getElementById('totalDebits').textContent = `₹${totalDebits.toFixed(2)}`;
        document.getElementById('netBalance').textContent = `₹${netBalance.toFixed(2)}`;
        
        // Get the net balance card element correctly
        const balanceElement = document.querySelector('.net-balance-card');
    
    // Remove any existing color classes that might be causing the styling issue
    balanceElement.classList.remove('bg-success', 'bg-danger', 'bg-info');
    
    // Apply appropriate styling class based on the balance value
    if (netBalance > 0) {
        balanceElement.style.setProperty('--metric-color', '#10b981');
        balanceElement.style.setProperty('--metric-color-light', '#34d399');
        balanceElement.style.setProperty('--metric-color-rgb', '16, 185, 129');
    } else if (netBalance < 0) {
        balanceElement.style.setProperty('--metric-color', '#ef4444');
        balanceElement.style.setProperty('--metric-color-light', '#f87171');
        balanceElement.style.setProperty('--metric-color-rgb', '239, 68, 68');
    } else {
        balanceElement.style.setProperty('--metric-color', '#06b6d4');
        balanceElement.style.setProperty('--metric-color-light', '#22d3ee');
        balanceElement.style.setProperty('--metric-color-rgb', '6, 182, 212');
    }
    } catch (error) {
        console.error('Error updating summary cards:', error);
        // Fallback to simple calculation if dashboard stats fail
        let totalCredits = 0;
        let totalDebits = 0;
        
        transactions.forEach(transaction => {
            if (transaction.transaction_type === 'credit') {
                totalCredits += parseFloat(transaction.amount);
            } else if (transaction.transaction_type === 'debit') {
                totalDebits += parseFloat(transaction.amount);
            }
        });
        
        const netBalance = totalCredits - totalDebits;
        
        document.getElementById('totalCredits').textContent = `₹${totalCredits.toFixed(2)}`;
        document.getElementById('totalDebits').textContent = `₹${totalDebits.toFixed(2)}`;
        document.getElementById('netBalance').textContent = `₹${netBalance.toFixed(2)}`;
    }
}

function renderTransactionsTable() {
    const tbody = document.querySelector('#transactionsTable tbody');
    const noTransactionsDiv = document.getElementById('noTransactions');
    const countBadge = document.getElementById('transactionCount');
    
    countBadge.textContent = filteredTransactions.length;
    
    if (filteredTransactions.length === 0) {
        document.getElementById('transactionsTable').style.display = 'none';
        noTransactionsDiv.style.display = 'block';
        return;
    }
    
    document.getElementById('transactionsTable').style.display = 'table';
    noTransactionsDiv.style.display = 'none';
    
    tbody.innerHTML = filteredTransactions.map(transaction => {
        const date = new Date(transaction.transaction_date).toLocaleDateString();
        const typeClass = transaction.transaction_type === 'credit' ? 'success' : 'danger';
        const typeIcon = transaction.transaction_type === 'credit' ? 'fas fa-arrow-up' : 'fas fa-arrow-down';
        const receiptContent = transaction.receipt_file ? 
            `<a href="/uploads/${transaction.receipt_file}" target="_blank" class="text-success" title="View attachment">
                <i class="fas fa-paperclip"></i> View
            </a>` : 
            '<i class="fas fa-paperclip text-muted" title="No attachment"></i>';
            
        // Add invoice details if this transaction is linked to an invoice
        let invoiceDetails = '';
        if (transaction.source === 'invoice' && transaction.invoice_number) {
            invoiceDetails = `
                <br><small class="text-info">
                    ${transaction.invoice_client_name ? `Client: ${transaction.invoice_client_name}` : ''}
                    ${transaction.invoice_status ? `<br>Status: <span class="badge bg-${transaction.invoice_status === 'paid' ? 'success' : transaction.invoice_status === 'overdue' ? 'danger' : 'warning'}">${transaction.invoice_status}</span>` : ''}
                </small>
            `;
        }
        
        return `
            <tr>
                <td>
                    <input type="checkbox" class="form-check-input transaction-checkbox" value="${transaction.id}">
                </td>
                <td>
                    <code class="text-primary">${transaction.unique_id || 'N/A'}</code>
                </td>
                <td>
                    <strong>${transaction.title}</strong>
                    ${transaction.source !== 'invoice' && transaction.description ? `<br><small class="text-muted">${transaction.description.substring(0, 50)}${transaction.description.length > 50 ? '...' : ''}</small>` : ''}
                    ${transaction.sub_user_name ? `<br><small class="text-success"><i class="fas fa-user me-1"></i>By: ${transaction.sub_user_name} (${transaction.sub_user_id})</small>` : ''}
                    ${invoiceDetails}
                </td>
                <td><strong>${ExpenseTracker.formatCurrency(transaction.amount)}</strong></td>
                <td>
                    <span class="badge bg-${typeClass}">
                        <i class="${typeIcon} me-1"></i>${transaction.transaction_type}
                    </span>
                </td>
                <td><span class="badge bg-${transaction.payment_method === 'online' ? 'success' : 'secondary'}">${transaction.payment_method || 'cash'}</span></td>
                <td>${transaction.utr_number || '-'}</td>
                <td>${date}</td>
                <td>${receiptContent}</td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-info" onclick="viewTransaction(${transaction.id})" title="View">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button type="button" class="btn btn-outline-primary" onclick="editTransaction(${transaction.id})" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="btn btn-outline-success" onclick="generateReceipt('transaction', ${transaction.id})" title="Generate Receipt">
                            <i class="fas fa-receipt"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger" onclick="deleteTransaction(${transaction.id})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function filterTransactions() {
    const uniqueId = document.getElementById('filterTransactionUniqueId').value.toLowerCase();
    const type = document.getElementById('filterTransactionType').value.toLowerCase();
    const category = document.getElementById('filterTransactionCategory').value.toLowerCase();
    const bankAccount = document.getElementById('filterTransactionBankAccount').value.toLowerCase();
    const dateFrom = document.getElementById('filterTransactionDateFrom').value;
    const dateTo = document.getElementById('filterTransactionDateTo').value;
    
    filteredTransactions = transactions.filter(transaction => {
        const matchesUniqueId = !uniqueId || (transaction.unique_id && transaction.unique_id.toLowerCase().includes(uniqueId));
        const matchesType = !type || transaction.transaction_type.toLowerCase().includes(type);
        const matchesCategory = !category || (transaction.category && transaction.category.toLowerCase().includes(category));
        
        // Bank account filter logic - Fixed
        let matchesBankAccount = true;
        if (bankAccount) {
            if (bankAccount === 'cash') {
                // Cash transactions: no bank_name or bank_name is 'Cash'
                matchesBankAccount = !transaction.bank_name || transaction.bank_name === 'Cash' || transaction.bank_name === '';
            } else {
                // Bank transactions: match by bank name
                matchesBankAccount = transaction.bank_name && transaction.bank_name.toLowerCase().includes(bankAccount);
            }
            // Debug logging
            if (bankAccount !== 'cash' && transaction.bank_name) {
                console.log(`Filtering by bank: ${bankAccount}, Transaction bank: ${transaction.bank_name}, Match: ${matchesBankAccount}`);
            }
        }
        
        let matchesDateRange = true;
        if (dateFrom || dateTo) {
            const transactionDate = new Date(transaction.transaction_date);
            if (dateFrom && transactionDate < new Date(dateFrom)) matchesDateRange = false;
            if (dateTo && transactionDate > new Date(dateTo)) matchesDateRange = false;
        }
        
        return matchesUniqueId && matchesType && matchesCategory && matchesBankAccount && matchesDateRange;
    });
    
    renderTransactionsTable();
}

function generateReceipt(transactionType, transactionId) {
    try {
        // Open receipt in new window
        const receiptUrl = `/api/receipt/${transactionType}/${transactionId}`;
        window.open(receiptUrl, '_blank', 'width=800,height=600,scrollbars=yes,resizable=yes');
    } catch (error) {
        console.error('Error generating receipt:', error);
        ExpenseTracker.showNotification('Error generating receipt: ' + error.message, 'error');
    }
}

async function saveTransaction() {
    const form = document.getElementById('transactionForm');
    const formData = new FormData(form);
    
    try {
        // Show loading on submit button
        const submitBtn = document.querySelector('#transactionModal button[type="submit"]');
        if (submitBtn) {
            ExpenseTracker.setButtonLoading(submitBtn, true);
        }
        
        let response;
        if (editingTransactionId) {
            const data = {
                title: formData.get('title'),
                description: formData.get('description'),
                purpose: formData.get('purpose'),
                payment_method: formData.get('payment_method'),
                bank_account_id: formData.get('bank_account_id'),
                utr_number: formData.get('utr_number'),
                amount: formData.get('amount'),
                transaction_type: formData.get('transaction_type'),
                category: formData.get('category'),
                transaction_date: formData.get('transaction_date')
            };
            response = await axios.put(`/api/transactions/${editingTransactionId}`, data);
        } else {
            response = await axios.post('/api/transactions', formData, {
                headers: {
                    'Content-Type': 'multipart/form-data'
                }
            });
        }
        
        // Hide loading on submit button
        if (submitBtn) {
            ExpenseTracker.setButtonLoading(submitBtn, false);
        }
        
        if (response.data.success) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('transactionModal'));
            modal.hide();
            await loadTransactions();
            
            ExpenseTracker.showNotification(`Transaction ${editingTransactionId ? 'updated' : 'added'} successfully!`, 'success');
        }
    } catch (error) {
        console.error('Error saving transaction:', error);
        
        // Hide loading on submit button
        if (submitBtn) {
            ExpenseTracker.setButtonLoading(submitBtn, false);
        }
        
        ExpenseTracker.showNotification('Error saving transaction: ' + (error.response?.data?.error || error.message), 'error');
    }
}

function editTransaction(id) {
    const transaction = transactions.find(t => t.id === id);
    if (!transaction) return;
    
    editingTransactionId = id;
    document.getElementById('transactionModalTitle').innerHTML = '<i class="fas fa-edit me-2"></i>Edit Transaction';
    
    document.getElementById('transactionId').value = transaction.id;
    document.getElementById('transactionTitle').value = transaction.title;
    document.getElementById('transactionAmount').value = transaction.amount;
    document.getElementById('transactionType').value = transaction.transaction_type;
    document.getElementById('transactionCategory').value = transaction.category || '';
    document.getElementById('transactionPurpose').value = transaction.purpose || '';
    document.getElementById('transactionPaymentMethod').value = transaction.payment_method || 'cash';
    document.getElementById('transactionUtrNumber').value = transaction.utr_number || '';
    document.getElementById('transactionDate').value = transaction.transaction_date;
    document.getElementById('transactionDescription').value = transaction.description || '';
    
    // Handle bank account selection
    if (transaction.bank_account_id) {
        document.getElementById('transactionBankAccount').value = transaction.bank_account_id;
        toggleTransactionBankSelection(); // Show bank selection if online
    } else {
        document.getElementById('transactionBankSelectionDiv').style.display = 'none';
        document.getElementById('transactionBankAccount').required = false;
    }
    
    const modal = new bootstrap.Modal(document.getElementById('transactionModal'));
    modal.show();
}

function viewTransaction(id) {
    try {
        console.log('Viewing transaction with ID:', id);
        console.log('Available transactions:', transactions);
        
        const transaction = transactions.find(t => t.id === parseInt(id));
        if (!transaction) {
            console.error('Transaction not found with ID:', id);
            ExpenseTracker.showNotification('Transaction not found!', 'error');
            return;
        }
        
        console.log('Found transaction:', transaction);
        
        const detailsDiv = document.getElementById('transactionDetails');
        if (!detailsDiv) {
            console.error('transactionDetails element not found');
            ExpenseTracker.showNotification('Error loading transaction details!', 'error');
            return;
        }
        
        const date = new Date(transaction.transaction_date).toLocaleDateString();
        const typeClass = transaction.transaction_type === 'credit' ? 'success' : 'danger';
        const typeIcon = transaction.transaction_type === 'credit' ? 'fas fa-arrow-up' : 'fas fa-arrow-down';
        
        detailsDiv.innerHTML = `
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label"><strong>Title:</strong></label>
                    <p class="form-control-plaintext">${transaction.title || 'N/A'}</p>
                </div>
                <div class="col-md-6">
                    <label class="form-label"><strong>Amount:</strong></label>
                    <p class="form-control-plaintext"><strong>${ExpenseTracker.formatCurrency(transaction.amount || 0)}</strong></p>
                </div>
                <div class="col-md-6">
                    <label class="form-label"><strong>Purpose:</strong></label>
                    <p class="form-control-plaintext">${transaction.purpose || '-'}</p>
                </div>
                <div class="col-md-6">
                    <label class="form-label"><strong>Type:</strong></label>
                    <p class="form-control-plaintext">
                        <span class="badge bg-${typeClass}">
                            <i class="${typeIcon} me-1"></i>${transaction.transaction_type || 'N/A'}
                        </span>
                    </p>
                </div>
                <div class="col-md-6">
                    <label class="form-label"><strong>Category:</strong></label>
                    <p class="form-control-plaintext">${transaction.category || '-'}</p>
                </div>
                <div class="col-md-6">
                    <label class="form-label"><strong>Payment Method:</strong></label>
                    <p class="form-control-plaintext">
                        <span class="badge bg-${transaction.payment_method === 'online' ? 'primary' : 'secondary'}">
                            <i class="fas fa-${transaction.payment_method === 'online' ? 'credit-card' : 'money-bill'} me-1"></i>
                            ${transaction.payment_method === 'online' ? 'Online' : 'Cash'}
                        </span>
                    </p>
                </div>
                <div class="col-md-6">
                    <label class="form-label"><strong>UTR Number:</strong></label>
                    <p class="form-control-plaintext">${transaction.utr_number || '-'}</p>
                </div>
                <div class="col-md-6">
                    <label class="form-label"><strong>Unique ID:</strong></label>
                    <p class="form-control-plaintext"><code>${transaction.unique_id || 'N/A'}</code></p>
                </div>
                ${transaction.payment_method === 'online' && transaction.bank_account_id ? `
                <div class="col-md-6">
                    <label class="form-label"><strong>Bank Account:</strong></label>
                    <p class="form-control-plaintext">${getTransactionBankName(transaction.bank_account_id, transaction)}</p>
                </div>
                ` : ''}
                <div class="col-md-6">
                    <label class="form-label"><strong>Date:</strong></label>
                    <p class="form-control-plaintext">${date}</p>
                </div>
                <div class="col-md-6">
                    <label class="form-label"><strong>Receipt:</strong></label>
                    <p class="form-control-plaintext">
                        ${transaction.receipt_file ? 
                            `<a href="/uploads/${transaction.receipt_file}" target="_blank" class="text-success">
                                <i class="fas fa-paperclip me-1"></i>View Attachment
                            </a>` : 
                            '<i class="fas fa-paperclip text-muted me-1"></i>No file attached'
                        }
                    </p>
                </div>
                ${transaction.description ? `
                <div class="col-12">
                    <label class="form-label"><strong>Description:</strong></label>
                    <p class="form-control-plaintext">${transaction.description}</p>
                </div>
                ` : ''}
                <div class="col-12">
                    <label class="form-label"><strong>Created:</strong></label>
                    <p class="form-control-plaintext">${transaction.created_at ? new Date(transaction.created_at).toLocaleString() : 'N/A'}</p>
                </div>
            </div>
        `;
        
        const modal = new bootstrap.Modal(document.getElementById('viewTransactionModal'));
        modal.show();
        
    } catch (error) {
        console.error('Error in viewTransaction:', error);
        ExpenseTracker.showNotification('Error loading transaction details: ' + error.message, 'error');
    }
}

async function deleteTransaction(id) {
    // Find the transaction to get its description for the confirmation message
    const transaction = transactions.find(t => t.id === id);
    const transactionDescription = transaction ? transaction.description : 'transaction';
    
    await ExpenseTracker.deleteItem(
        id,
        `transaction "${transactionDescription}"`,
        '/api/transactions',
        async () => {
            // Add a small delay to ensure database is fully updated
            await new Promise(resolve => setTimeout(resolve, 500));
            await loadTransactions();
        }
    );
}

// Bank Management for Transactions
let userBanks = [];

// Load user banks on page load
document.addEventListener('DOMContentLoaded', function() {
    loadUserBanks();
});

async function loadUserBanks() {
    try {
        const response = await fetch('/api/user-banks');
        if (response.ok) {
            userBanks = await response.json();
            populateTransactionBankDropdown();
        } else {
            console.error('Failed to load user banks');
        }
    } catch (error) {
        console.error('Error loading user banks:', error);
    }
}

function populateTransactionBankDropdown() {
    const dropdown = document.getElementById('transactionBankAccount');
    dropdown.innerHTML = '<option value="">Choose a bank account...</option>';
    
    userBanks.forEach(bank => {
        const option = document.createElement('option');
        option.value = bank.id;
        option.textContent = `${bank.bank_name} - ${bank.account_number}`;
        dropdown.appendChild(option);
    });
    
    // Also populate the filter bank account dropdown
    populateFilterTransactionBankDropdown();
}

function populateFilterTransactionBankDropdown() {
    const filterDropdown = document.getElementById('filterTransactionBankAccount');
    if (!filterDropdown) return;
    
    filterDropdown.innerHTML = '<option value="">All Accounts</option><option value="cash">Cash</option>';
    
    userBanks.forEach(bank => {
        const option = document.createElement('option');
        option.value = bank.bank_name;
        option.textContent = `${bank.bank_name} - ${bank.account_number}`;
        filterDropdown.appendChild(option);
    });
}

function toggleTransactionBankSelection() {
    const paymentMethod = document.getElementById('transactionPaymentMethod').value;
    const bankSelectionDiv = document.getElementById('transactionBankSelectionDiv');
    const bankAccountSelect = document.getElementById('transactionBankAccount');
    
    if (paymentMethod === 'online') {
        bankSelectionDiv.style.display = 'block';
        bankAccountSelect.required = true;
    } else {
        bankSelectionDiv.style.display = 'none';
        bankAccountSelect.required = false;
        bankAccountSelect.value = '';
        // Clear the bank account selection when switching to cash
        bankAccountSelect.selectedIndex = 0;
    }
}

function getTransactionBankName(bankAccountId, bankData) {
    // If bank data is provided directly from API response, use it
    if (bankData && bankData.bank_name) {
        return `${bankData.bank_name} - ${bankData.account_number}`;
    }
    
    // Fallback to userBanks array lookup
    const bank = userBanks.find(b => b.id == bankAccountId);
    return bank ? `${bank.bank_name} - ${bank.account_number}` : 'Unknown Bank';
}

// Reset form when modal is closed
document.getElementById('transactionModal').addEventListener('hidden.bs.modal', function() {
    document.getElementById('transactionForm').reset();
    document.getElementById('transactionDate').valueAsDate = new Date();
    editingTransactionId = null;
    document.getElementById('transactionModalTitle').innerHTML = '<i class="fas fa-plus me-2"></i>Add Transaction';
    // Hide bank selection and clear bank account
    document.getElementById('transactionBankSelectionDiv').style.display = 'none';
    document.getElementById('transactionBankAccount').value = '';
    document.getElementById('transactionBankAccount').required = false;
});

// Bulk operations functionality
function updateBulkButtons() {
    const checkboxes = document.querySelectorAll('.transaction-checkbox:checked');
    const bulkDeleteBtn = document.getElementById('bulkDeleteTransactions');
    const bulkExportBtn = document.getElementById('bulkExportTransactions');
    const selectedCount = document.getElementById('selectedTransactionsCount');
    const selectedDeleteCount = document.getElementById('selectedTransactionsDeleteCount');
    
    const count = checkboxes.length;
    selectedCount.textContent = count;
    selectedDeleteCount.textContent = count;
    const showButtons = count > 0;
    bulkDeleteBtn.style.display = showButtons ? 'block' : 'none';
    bulkExportBtn.style.display = showButtons ? 'block' : 'none';
}

// Select all functionality
document.addEventListener('DOMContentLoaded', function() {
    const selectAllCheckbox = document.getElementById('selectAllTransactions');
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.transaction-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateBulkButtons();
        });
    }
    
    // Add event listeners to individual checkboxes
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('transaction-checkbox')) {
            updateBulkButtons();
        }
    });
});

async function bulkExportTransactions() {
    const selectedCheckboxes = document.querySelectorAll('.transaction-checkbox:checked');
    const selectedIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));
    
    if (selectedIds.length === 0) {
        ExpenseTracker.showNotification('No transactions selected for export.', 'warning');
        return;
    }
    
    try {
        // Show loading state
        const exportBtn = document.getElementById('bulkExportTransactions');
        const originalText = exportBtn.innerHTML;
        exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Exporting...';
        exportBtn.disabled = true;
        
        // Create a form to submit the selected IDs
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/api/transactions/export';
        form.target = '_blank';
        
        // Add selected IDs as hidden inputs
        selectedIds.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'transaction_ids';
            input.value = id;
            form.appendChild(input);
        });
        
        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);
        
        ExpenseTracker.showNotification(`Exporting ${selectedIds.length} selected transaction(s) to PDF...`, 'success');
        
        // Reset button state after a delay
        setTimeout(() => {
            exportBtn.innerHTML = originalText;
            exportBtn.disabled = false;
        }, 2000);
        
    } catch (error) {
        console.error('Error exporting transactions:', error);
        ExpenseTracker.showNotification('Error exporting transactions: ' + error.message, 'error');
        
        // Reset button state
        const exportBtn = document.getElementById('bulkExportTransactions');
        exportBtn.innerHTML = '<i class="fas fa-file-pdf me-1"></i>Export Selected (<span id="selectedTransactionsCount">0</span>)';
        exportBtn.disabled = false;
    }
}

async function bulkDeleteTransactions() {
    const selectedCheckboxes = document.querySelectorAll('.transaction-checkbox:checked');
    const selectedIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));
    
    if (selectedIds.length === 0) {
        ExpenseTracker.showNotification('No transactions selected for deletion.', 'warning');
        return;
    }
    
    // Use styled delete confirmation modal instead of basic confirm()
    ExpenseTracker.showDeleteConfirmation(
        `Are you sure you want to delete ${selectedIds.length} selected transaction(s)? This will adjust account balances. This action cannot be undone.`,
        'transactions',
        async () => {
        try {
            // Show loading state
            const deleteBtn = document.getElementById('bulkDeleteTransactions');
            const originalText = deleteBtn.innerHTML;
            deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Deleting...';
            deleteBtn.disabled = true;
            
            // Use the bulk delete endpoint
            const response = await fetch('/api/transactions/bulk-delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    transaction_ids: selectedIds
                })
            });
            
            const result = await response.json();
            
            if (response.ok && result.success) {
                ExpenseTracker.showNotification(result.message, 'success');
                console.log('Bulk delete result:', result);
            } else {
                throw new Error(result.message || 'Failed to delete transactions');
            }
            
            // Add a small delay to ensure database is fully updated
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Reload transactions and update UI
            await loadTransactions();
            
            // Reset button state
            deleteBtn.innerHTML = originalText;
            deleteBtn.disabled = false;
            
            // Reset select all checkbox
            document.getElementById('selectAllTransactions').checked = false;
            updateBulkButtons();
            
        } catch (error) {
            console.error('Error in bulk delete:', error);
            ExpenseTracker.showNotification('Error deleting transactions: ' + (error.response?.data?.error || error.message), 'error');
            
            // Reset button state
            const deleteBtn = document.getElementById('bulkDeleteTransactions');
            deleteBtn.innerHTML = '<i class="fas fa-trash me-1"></i>Delete Selected (<span id="selectedTransactionsDeleteCount">0</span>)';
            deleteBtn.disabled = false;
        }
        }
    );
}
</script>
{% endblock %}
